<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Underwater Adventure Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(to bottom, #001a33, #003d5c);
            color: #fff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow: hidden;
        }
        
        .page-wrapper {
            height: 720px;
            overflow: hidden;
            position: relative;
        }
        
        .scroll-container {
            height: 100%;
            overflow-y: hidden;
            position: relative;
        }
        
        .content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            transition: top 0.3s ease;
        }
        
        .scroll-control {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            height: 500px;
            width: 20px;
        }
        
        .scroll-slider {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
            width: 20px;
            height: 100%;
            cursor: pointer;
            background: rgba(0, 128, 255, 0.3);
            border-radius: 10px;
            outline: none;
        }
        
        .scroll-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            border: 2px solid #00ccff;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.8);
        }
        
        .scroll-slider::-moz-range-thumb {
            width: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            border: 2px solid #00ccff;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.8);
        }
        
        .scroll-slider::-webkit-slider-thumb:hover {
            background: linear-gradient(to bottom, #00ffff, #00ccff);
            box-shadow: 0 0 15px rgba(0, 255, 255, 1);
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: rgba(0, 40, 80, 0.8);
            border: 2px solid #0080ff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 128, 255, 0.5);
            min-height: 1200px;
        }
        
        h1 {
            text-align: center;
            color: #00ccff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ccff;
        }
        
        .audio-controls {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .audio-controls button {
            width: 120px;
            margin: 0 5px;
        }
        .close-x {
            position: absolute;
            top: 10px;
            right: 15px;
            background: transparent;
            border: none;
            color: #ff4444;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .volume-control {
            display: inline-block;
            margin-left: 10px;
        }
        
        .volume-control input {
            width: 100px;
            vertical-align: middle;
        }
        
        #textArea {
            width: 100%;
            height: 300px;
            background: #001a33;
            color: #00ff88;
            border: 2px solid #0080ff;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-y: scroll;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }
        
        .movement-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .action-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: linear-gradient(to bottom, #0080ff, #0050cc);
            color: white;
            border: 2px solid #00ccff;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            box-shadow: 0 0 15px #00ccff;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .movement-panel button {
            padding: 15px;
            font-size: 14px;
        }
        
        .empty-cell {
            background: transparent;
            border: none;
        }
        
        .empty-cell:hover {
            background: transparent;
            box-shadow: none;
            transform: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background: linear-gradient(to bottom, #001a33, #003d5c);
            margin: 15% auto;
            padding: 20px;
            border: 2px solid #00ccff;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
        }
        
        .modal-content h2 {
            color: #00ccff;
            margin-bottom: 15px;
        }
        
        .item-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .item-button {
            width: 100%;
            margin: 5px 0;
            text-align: left;
        }
        
        .close-modal {
            background: #cc0000;
            border-color: #ff0000;
        }
        
        @media (max-width: 768px) {
            .action-panel {
                grid-template-columns: repeat(2, 1fr);
            }
            
            button {
                font-size: 10px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="scroll-container">
            <div class="content-wrapper" id="contentWrapper">
                <div class="container">
                    <h1>ðŸŒŠ UNDERWATER ADVENTURE ðŸŒŠ</h1>
        
        <div class="audio-controls">
            <button type="button" onclick="toggleMusic()" id="musicToggle" aria-label="Toggle background music" tabindex="0">ðŸ”Š Music: ON</button>
            <div class="volume-control">
                <label for="volumeSlider">Volume: </label>
                <input type="range" id="volumeSlider" min="0" max="100" value="30" oninput="changeVolume(this.value)" aria-label="Music volume" tabindex="0">
                <span id="volumeDisplay">30%</span>
            </div>
        </div>
        
        <div id="textArea"></div>
        
        <div class="movement-panel">
            <button class="empty-cell" disabled aria-hidden="true"></button>
            <button type="button" onclick="move(0)" aria-label="Move North" tabindex="0">NORTH</button>
            <button class="empty-cell" disabled aria-hidden="true"></button>
            <button type="button" onclick="move(3)" aria-label="Move West" tabindex="0">WEST</button>
            <button type="button" onclick="move(1)" aria-label="Move South" tabindex="0">SOUTH</button>
            <button type="button" onclick="move(2)" aria-label="Move East" tabindex="0">EAST</button>
        </div>
        
        <div class="action-panel">
            <button type="button" onclick="getItem()" aria-label="Get item" tabindex="0">GET</button>
            <button type="button" onclick="rest()" aria-label="Rest" tabindex="0">REST</button>
            <button type="button" onclick="useItem()" aria-label="Use item" tabindex="0">USE</button>
            <button type="button" onclick="openDoor()" aria-label="Open door" tabindex="0">OPEN</button>
            <button type="button" onclick="closeDoor()" aria-label="Close door" tabindex="0">CLOSE</button>
            <button type="button" onclick="examine()" aria-label="Examine" tabindex="0">EXAMINE</button>
            <button type="button" onclick="showInventory()" aria-label="Show inventory" tabindex="0">INVENTORY</button>
            <button type="button" onclick="lookAround()" aria-label="Look around" tabindex="0">LOOK</button>
            <button type="button" onclick="sitStand()" aria-label="Sit or stand" tabindex="0">SIT/STAND</button>
            <button type="button" onclick="talk()" aria-label="Talk" tabindex="0">TALK</button>
            <button type="button" onclick="takeQuest()" aria-label="Take quest" tabindex="0">TAKE QUEST</button>
            <button type="button" onclick="giveItem()" aria-label="Give item" tabindex="0">GIVE ITEM</button>
            <button type="button" onclick="showMap()" aria-label="Show map" tabindex="0" style="background: linear-gradient(to bottom, #00ccff, #0050cc);">MAP</button>
        </div>

            </div>
        </div>
    </div>
    
    <!-- Scroll Controls -->
    <div class="scroll-control">
        <input type="range" class="scroll-slider" id="scrollSlider" min="0" max="100" value="0" 
               orient="vertical" oninput="scrollToPosition(this.value)">
    </div>
    
    <div id="useItemModal" class="modal" aria-modal="true" role="dialog">
        <div class="modal-content">
            <button class="close-x" onclick="closeModal()" aria-label="Close use item modal">Ã—</button>
            <h2>Select Item to Use</h2>
            <div id="itemList" class="item-list"></div>
            <button class="close-modal" onclick="closeModal()" aria-label="Cancel use item">Cancel</button>
        </div>
    </div>

    <!-- Map Modal -->
<div id="mapModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content" style="max-width: 90%; width: fit-content; max-height: 90vh; overflow: auto; margin: 10px auto; position: relative;">
        <button class="close-x" onclick="closeMapModal()" aria-label="Close map modal">Ã—</button>
        <h2>Underwater Navigation Map</h2>
        <div style="overflow: auto; background: #001a33; padding: 10px; border-radius: 5px; border: 1px solid #0080ff; max-height: 70vh;">
            <pre id="mapContent" style="font-size: 12px; line-height: 14px; color: #00ff88; margin: 0; white-space: pre; word-break: break-all;"></pre>
        </div>
        <button class="close-modal" onclick="closeMapModal()" aria-label="Close map" style="margin-top: 15px;">Close Map</button>
    </div>
</div>

    <audio id="backgroundMusic" loop>
        <!-- Add your music file here. Place the file in the same folder as this HTML -->
        <source src="underwater_theme.mp3" type="audio/mpeg">
        <source src="underwater_theme.wav" type="audio/wav">
        <source src="underwater_theme.ogg" type="audio/ogg">
    </audio>

    <script>
        // === GAME STATE VARIABLES ===
        let mermaidDialogueCount = 0;
        let turtleDialogueCount = 0;
        let pirateDialogueCount = 0;
        let dragonDialogueCount = 0;
        let cookDialogueCount = 0;
        let isSitting = false;
        let currentRoom = 2;
        let doorOpen = false;
        let cellarOpen = false; // Tracks if the cellar is unlocked
        let gameStarted = false;
        let inventory = [];
        let musicPlaying = false;
        let currentScrollPosition = 0;
        let maxScroll = 0;
        // Quest state
        let mermaidQuestStarted = false;
        let mermaidQuestComplete = false;
        let turtleQuestStarted = false;
        let turtleQuestComplete = false;
        let pirateQuestStarted = false;
        let pirateQuestComplete = false;
        let pirateGhostMad = false; // Tracks if ghost is mad about hat
        let dragonQuestStarted = false;
        let dragonQuestComplete = false;
        let cookQuestStarted = false;
        let cookQuestComplete = false;

        // === ASCII MAP ===
        const asciiMap = `
                     *---------------*     *---------------*                           *---------------*          
                     |  Under Water  |     |     Aqua      |                           |               |          
                     |    Casino     |     |   Clothing    |                           |   Crows Nest  |                           
                     |               |     |     shop      |                           |               |
                     *---------------*     *---------------*                           *---------------*
                         |     |               |     |                                       |   |
                         |     |               |     |                                       |   |  
                         |     |               |     |                                       |   |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*     *---------------*          
|  Under Water  |____|  Under Water  |_____|      Sea      |_____|               |_____|               |_____|               |          
|   Restaurant  |    |     Lobby     |     | Cave Entrance |     |  Sunken Ship  |     |      Deck     |     |  Captins Room |                           
|               |____|               |_____|               |_____|               |_____|               |-----|               |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*     *---------------*    
                         |      |              |     |                |     |                |    |
                         |      |              |     |                |     |           *---------------*              
                         |      |              |     |                |     |           |               |               
                         |      |              |     |                |     |           |    Cellar     |                           
                         |      |              |     |                |     |           |               |     
                         |      |              |     |                |     |           *---------------*
                         |      |              |     |                |     |                      
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*          
|  Under Water  |____|  Under Water  |     |     Shark     |_____|  Under Water  |_____|     Turtle    |          
|  Storage Room |    |   Corridor    |     |     Grove     |     |    Garden     |     |     Palace    |                           
|               |____|               |     |               |_____|               |_____|               |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*             
                                                 |   |                |     |
                                                 |   |                |     |
                                                 |   |                |     |
                                           *---------------*     *---------------*              
                                           |   Sea Dragon  |     |               |               
                                           |     Lair      |     | Mermaid Room  |                           
                                           |               |     |               |     
                                           *---------------*     *---------------*     
                                                                     |      |
                                                                     |      |
                                           *---------------*     *---------------*     *---------------*          
                                           |               |_____|               |_____|               |          
                                           |  Gem Rooom    |     |  Kings Room   |     | Crystal Room  |                           
                                           |               |_____|               |_____|               |
                                           *---------------*     *---------------*     *---------------*
                                                                       |   |
                                                                       |   | 
                                                                       |   |
                                                                 *---------------*              
                                                                 |   Tressure    |               
                                                                 |     Room      |                           
                                                                 |               |     
                                                                 *---------------*`;

        // === ACCESSIBILITY & MODAL UX ===
        // Improved: close modal on background click, only if visible
        window.addEventListener('click', function(event) {
            const itemModal = document.getElementById('useItemModal');
            const mapModal = document.getElementById('mapModal');
            if (event.target === itemModal && itemModal.style.display === 'block') {
                itemModal.style.display = 'none';
            }
            if (event.target === mapModal && mapModal.style.display === 'block') {
                mapModal.style.display = 'none';
            }
        });

        // === SCROLL BAR LOGIC ===
        // Debounced resize for performance
        window.addEventListener('load', calculateMaxScroll);
        window.addEventListener('resize', debounce(calculateMaxScroll, 100));
        function calculateMaxScroll() {
            const wrapper = document.getElementById('contentWrapper');
            const container = document.querySelector('.page-wrapper');
            maxScroll = Math.max(0, wrapper.offsetHeight - container.offsetHeight);
        }
        function scrollToPosition(value) {
            currentScrollPosition = (value / 100) * maxScroll;
            const wrapper = document.getElementById('contentWrapper');
            wrapper.style.top = `-${currentScrollPosition}px`;
        }
        function debounce(fn, ms) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        // === MAP MODAL ===
        function showMap() {
            document.getElementById('mapContent').textContent = asciiMap;
            document.getElementById('mapModal').style.display = 'block';
        }
        function closeMapModal() {
            document.getElementById('mapModal').style.display = 'none';
        }
        
        // === GAME DATA ===
        // Use const for immutable data
        const rooms = [
            "Aquatic Clothing Shop", "Underwater Casino", "Underwater Cave (Car Park)", 
            "Underwater Lobby", "Underwater Restaurant", "Underwater Corridor", 
            "Underwater Storage Room", "Mermaid Room", "Underwater Garden", "Sunken Ship", 
            "Captain's Room", "Crow's Nest", "Deck", "Cellar", "Gem Room", "Treasure Room", 
            "Crystal Room", "King's Room", "Turtle Palace", "Shark Grove", "Sea Dragon's Lair"
        ];
        
        const roomConnections = [
            [-1, 2, -1, -1],   // 0: Aquatic Clothing Shop
            [-1, 3, -1, -1],   // 1: Casino
            [0, 19, 9, 3],     // 2: Carpark
            [1, 5, 2, 4],      // 3: Lobby
            [-1, -1, 3, -1],   // 4: Restaurant
            [3, -1, -1, 6],    // 5: Corridor
            [-1, -1, 5, -1],   // 6: Storage Room
            [8, 17, -1, -1],   // 7: Mermaid Room
            [9, 7, 18, 19],    // 8: Garden
            [-1, 8, 12, 2],    // 9: Sunken Ship
            [-1, -1, -1, 12],  // 10: Captain's Room
            [-1, 12, -1, -1],  // 11: Crow's Nest
            [11, 13, 10, 9],   // 12: Deck
            [12, -1, -1, -1],  // 13: Cellar
            [-1, -1, 17, -1],  // 14: Gem Room
            [17, -1, -1, -1],  // 15: Treasure Room
            [-1, -1, -1, 17],  // 16: Crystal Room
            [7, 15, 16, 14],   // 17: King's Room
            [-1, -1, -1, 8],   // 18: Turtle Palace
            [2, 20, 8, -1],    // 19: Shark Grove
            [19, -1, -1, -1]   // 20: Sea Dragon's Lair
        ];
        
        const roomDescriptions = {
            0: "Aquatic clothing shop",
            1: "Under water seaweed infested casino",
            2: "Under water cave, the current is pulling you, choose if you dare",
            3: "Under water hotel lobby",
            4: "Under water restaurant",
            5: "Under water corridor",
            6: "Under water store room",
            7: "Mermaid Room",
            8: "Tranquil under water garden",
            9: "Sunken ship",
            10: "Captain's room that used to be a pirate's! You feel a cold shiver down your spine while gazing into the room",
            11: "Crow's nest, the top of the sunken ship, you think it might be a steep height but you realize that you are still under water",
            12: "Sunken ship's deck, which makes you recall the time that you were sea sick and how slippery the wood was on your feet when walking on it, however you realize that neither of these things apply here since you're under the water",
            13: "Cold dark cellar under some worn wooden boards, do you think it's abandoned? For your case let's hope so",
            14: "Gem room, with all the sparkling light it's practically pulling you in",
            15: "Hidden treasure room, there might even be a treasure chest who knows?",
            16: "Crystal room, right next to a gem room who would have guessed? Not me",
            17: "King's room with a throne in the middle, you think to yourself could this be your destiny?",
            18: "Palace where a bunch of sea turtles have made home in, would you want to disturb their peace? I mean go right ahead I am sure they're ok with outsiders",
            19: "Grove that is infested with sharks, who would have thought of all places. Well you could turn back now but some of them are eyeing you, might as well swim through, nothing could go wrong..",
            20: "Sea dragon's lair which might not be the best idea since you just risked your life swimming through a grove of sharks but who am I to tell you no"
        };
        
        const items = {
                "GHOST_KEY": {name: "GHOST_KEY", description: "a spectral key shimmering with ghostly light, said to unlock the cellar", location: -1, canCarry: true}, // Given by Pirate Ghost
            "DOOR": {name: "DOOR", description: "a closed store room door", location: 5, canCarry: false},
            "CELLAR_DOOR": {name: "CELLAR_DOOR", description: "a heavy cellar door with a ghostly lock", location: 13, canCarry: false},
            "MAGNET": {name: "MAGNET", description: "a magnet floating in the glimmering water", location: 3, canCarry: true},
            "KEY": {name: "KEY", description: "a rusty old key that looks like it might open something", location: 3, canCarry: true},
            "METER": {name: "METER", description: "a sunken parking meter filled with water", location: 2, canCarry: false},
            "ROULETTE": {name: "ROULETTE", description: "a floating roulette wheel in the water", location: 1, canCarry: false},
            "MONEY": {name: "MONEY", description: "some shriveled money drifting in the water", location: 1, canCarry: true},
            "LIFEJACKET": {name: "LIFEJACKET", description: "a life jacket... under water? Yeah, I've seen everything", location: 0, canCarry: false},
            "GEM": {name: "GEM", description: "some gems dug into the floor of the cavern, I don't think they look edible yet your belly roars as you gaze upon them, maybe you should have stopped to eat before scuba diving", location: 14, canCarry: true}, // Gem Room
            "CRYSTAL": {name: "CRYSTAL", description: "the sheer shine of the bright light is enough to blind you and maybe you should stop staring... hey! I said stop", location: 16, canCarry: true}, // Crystal Room
            "DRAGONEGG": {name: "DRAGONEGG", description: "an egg of a dragon laid on the floor, it wouldn't lead to conflict at all if you take it right? Is what you think to yourself yet you already have your hands around it", location: 13, canCarry: true}, // Cellar
            "HAT": {name: "HAT", description: "a captain's hat, might as well put it on", location: 9, canCarry: true}, // Sunken Ship
            "SEAWEED": {name: "SEAWEED", description: "finally some food... wait a minute this is just sea weed and I thought this was a 5 star restaurant", location: 8, canCarry: true}, // Garden
            "TELESCOPE": {name: "TELESCOPE", description: "an old telescope from the age of pirates maybe you can find your destiny of your adventure by looking through it", location: 11, canCarry: false},
            "ROPE": {name: "ROPE", description: "some rope seems to have fallen off the mast of the ship you could pick it up if you want nobody is stopping you", location: 12, canCarry: true},
            "BONES": {name: "BONES", description: "the bones of a fallen pirate in battle, definitely not creepy at all", location: 13, canCarry: false},
            "CHEST": {name: "CHEST", description: "a chest of treasures on a platform in the middle of the room, we haven't seen this before. You should just go pick it up", location: 15, canCarry: true},
            "THRONE": {name: "THRONE", description: "a throne in the middle of the room, might as well be yours you have earned it after making this adventure", location: 17, canCarry: false},
            "MERMAID": {name: "MERMAID", description: "a Mermaid is gliding through the room maybe you can talk to her", location: 7, canCarry: false},
            // NPCs
            "TURTLE_ELDER": {name: "TURTLE_ELDER", description: "an ancient turtle elder with a wise look", location: 18, canCarry: false},
            "PIRATE_GHOST": {name: "PIRATE_GHOST", description: "a ghostly pirate captain, shimmering faintly", location: 10, canCarry: false},
            "SEA_DRAGON": {name: "SEA_DRAGON", description: "a majestic sea dragon coils in the lair, its eyes glowing with wisdom", location: 20, canCarry: false},
            "COOK": {name: "COOK", description: "a cheerful ship's cook, busy with underwater ingredients", location: 4, canCarry: false}
        };
        
        // === UTILITY ===
        function setText(text) {
            document.getElementById('textArea').textContent = text;
        }
        
        function showIntroduction() {
            const intro = `=== UNDERWATER ADVENTURE ===

Your adventure starts by you getting on a train.
As you sit down you feel yourself starting to get sleepy.
Suddenly you fall into a deep sleep. When you wake up there is a harsh darkness surrounding you.
You figure that walking slowly to the door is the best option.
Once you open the door you are met with the soft sounds of water hitting the slick concrete floor.
The train leaves and you are now stranded in a cold and dark cavern.
There is an opening that you start walking through.
It's a dark and humid passage with water dripping from the ceiling.
Finally, you reach a drop off that leads into an underwater passage that is drawing you in.
Luckily you brought your scuba gear along.
Those marine biology classes finally paid off, as your professor always said:
-Take your scuba gear wherever you go and that's an order!-
You picture him yelling at you in the marine biology classroom.
You didn't particularly hate him, you knew he meant well.
You were just in the class to discover the wonders of mermaids.
Your biggest dream was to meet a mermaid in real life and hopefully become friends.
The drop off that leads into an underwater passage of your dreams is in front of you.
Thus you decide to jump right in and explore the area.

=== Click LOOK to begin your adventure! ===`;
            setText(intro);
        }
        
        function startMusic() {
            if (!musicPlaying) {
                const music = document.getElementById('backgroundMusic');
                music.volume = 0.3;
                music.play().catch(e => {
                    console.log("Music autoplay blocked. Click the page to start music.");
                    // Show a message to the user
                    alert("Click OK to enable background music!");
                    music.play();
                });
                musicPlaying = true;
            }
        }
        
        function toggleMusic() {
            const music = document.getElementById('backgroundMusic');
            const button = document.getElementById('musicToggle');
            
            if (musicPlaying) {
                music.pause();
                musicPlaying = false;
                button.textContent = 'ðŸ”‡ Music: OFF';
            } else {
                music.play().catch(e => {
                    alert("Click OK to enable background music!");
                    music.play();
                });
                musicPlaying = true;
                button.textContent = 'ðŸ”Š Music: ON';
            }
        }
        
        function changeVolume(value) {
            const music = document.getElementById('backgroundMusic');
            music.volume = value / 100;
            document.getElementById('volumeDisplay').textContent = value + '%';
        }
        
        // === MAIN GAME ACTIONS ===

        // === GIVE ITEM LOGIC ===
        function giveItem() {
            // Only allow giving if in a quest NPC room
            let text = "\n=== GIVE ITEM ===\n";
            let npc = null;
            let questItem = null;
            let questStarted = false;
            let questComplete = false;
            let npcName = "";
            if (currentRoom === 7) { // Mermaid
                npc = "mermaid";
                questItem = "CRYSTAL";
                questStarted = mermaidQuestStarted;
                questComplete = mermaidQuestComplete;
                npcName = "Mermaid";
            } else if (currentRoom === 18) { // Turtle Elder
                npc = "turtle";
                questItem = "GEM";
                questStarted = turtleQuestStarted;
                questComplete = turtleQuestComplete;
                npcName = "Turtle Elder";
            } else if (currentRoom === 10) { // Pirate Ghost
                npc = "pirate";
                questItem = "HAT";
                questStarted = pirateQuestStarted;
                questComplete = pirateQuestComplete;
                npcName = "Pirate Ghost";
            } else if (currentRoom === 20) { // Sea Dragon
                npc = "dragon";
                questItem = "DRAGONEGG";
                questStarted = dragonQuestStarted;
                questComplete = dragonQuestComplete;
                npcName = "Sea Dragon";
            } else if (currentRoom === 4) { // Cook
                npc = "cook";
                questItem = "SEAWEED";
                questStarted = cookQuestStarted;
                questComplete = cookQuestComplete;
                npcName = "Cook";
            }
            if (!npc) {
                text += "There is no one here to give an item to.";
                setText(text);
                return;
            }
            if (!questStarted) {
                text += `You need to take the quest from the ${npcName} first!`;
                setText(text);
                return;
            }
            if (questComplete) {
                text += `You have already completed the ${npcName}'s quest.`;
                setText(text);
                return;
            }
            if (!inventory.includes(questItem)) {
                text += `You do not have the required item (${questItem}) to give to the ${npcName}.`;
                setText(text);
                return;
            }
            // Remove item from inventory and complete quest
            inventory = inventory.filter(i => i !== questItem);
            if (npc === "mermaid") {
                mermaidQuestComplete = true;
                text += "The Mermaid's eyes light up as you hand her the CRYSTAL. 'Thank you, friend! This is just what I needed for my collection. Please accept my blessing as a token of my gratitude.' Quest complete!";
            } else if (npc === "turtle") {
                turtleQuestComplete = true;
                text += "The Turtle Elder smiles slowly as you return the GEM. 'Ah, my precious gem! Thank you, young one. May your journey be as steady and wise as the tides.' Quest complete!";
            } else if (npc === "pirate") {
                pirateQuestComplete = true;
                pirateGhostMad = false;
                // Give the player the ghost key
                if (!inventory.includes("GHOST_KEY")) {
                    inventory.push("GHOST_KEY");
                    text += "The Pirate Ghost beams as you hand over the HAT. 'Arrr! Ye found me hat! Thank ye, matey. As promised, take this ghostly keyâ€”it'll open the cellar for ye. May fortune and fair winds follow ye always.' You receive the GHOST_KEY! Quest complete!";
                } else {
                    text += "The Pirate Ghost beams as you hand over the HAT. 'Arrr! Ye found me hat! Thank ye, matey. May fortune and fair winds follow ye always.' Quest complete!";
                }
            } else if (npc === "dragon") {
                dragonQuestComplete = true;
                text += "The Sea Dragon coils around the DRAGONEGG protectively. 'You have done a great deed, brave one. My thanksâ€”and may the ocean's power be with you.' Quest complete!";
            } else if (npc === "cook") {
                cookQuestComplete = true;
                text += "The Cook claps his fins in delight as you give him the SEAWEED. 'Marvelous! This will make my stew legendary. Thank you, friend! Come back anytime for a meal.' Quest complete!";
            }
            setText(text);
        }
        function lookAround() {
            gameStarted = true;
            startMusic();
            let text = "\n=== LOOK AROUND ===\n";
            text += `I am in a ${roomDescriptions[currentRoom]}.\n\n`;
            const directions = ["NORTH", "SOUTH", "EAST", "WEST"];
            for (let i = 0; i < 4; i++) {
                if (roomConnections[currentRoom][i] !== -1) {
                    const nextRoom = roomConnections[currentRoom][i];
                    text += `There is an exit ${directions[i]} to a ${roomDescriptions[nextRoom]}.\n`;
                }
            }
            text += "\n";
            for (let itemKey in items) {
                const item = items[itemKey];
                if (item.location === currentRoom) {
                    text += `I see ${item.description}.\n`;
                }
            }
            setText(text);
        }
        
        function examine() {
            let text = "\n=== EXAMINE ===\n";
            const examines = {
                0: "The simple reason for that it provides fantastic reliability and can save your life without any exaggeration.",
                1: "The roulette wheel floating. In the game, a player may choose to place a bet on a single number, various groupings of numbers, the color red or black, whether the number is odd or even, or if the numbers are high or low. And the shriveled money on the table, it is basically gone at this point maybe you should have grabbed it sooner.",
                2: "A place to put tax or fee paid for some liberty or privilege of staying at the cave I guess.",
                3: "A magnet is a material or object that produces a magnetic field. This magnetic field is invisible but is responsible for the most notable property.",
                4: "Seaweed species such as kelps provide essential nursery habitat for fisheries and other marine species and thus protect food sources. The ship's cook is here, humming a tune.",
                5: "There is a door in the store room it looks old and worn.",
                6: "There is a door in the store room it looks old and worn.",
                7: "A mythological creature that is half maiden and half fish or sea serpent. She seems to want to talk to you.",
                10: "Wearing a bicorn hat worn the other way, with the pressed-up sides on the front and back of the hat, and a skull and cross bones. You sense a ghostly presence nearby...",
                11: "A telescope is a device used to observe distant objects by their emission, absorption, or reflection of electromagnetic radiation. Originally meaning only an optical instrument using lenses, curved mirrors, or a combination of both to observe distant objects.",
                12: "Ropes have tensile strength and so can be used for dragging and lifting. Rope is thicker and stronger than similarly constructed cord, string, and twine.",
                13: "The human skeleton is the internal framework of the human body. It is composed of around 270 bones at birth - this total decreases to around 206 bones by adulthood after some bones get fused together, yet they are definitely not all there by what you can tell, which creeps you out.",
                14: "It is a piece of mineral crystal which, in cut and polished form, is used to make jewelry or other adornments.",
                15: "A large box that is filled with gold, silver, jewels, etc. Often used figuratively. The house is a treasure chest filled with artifacts.",
                16: "It is a solid material whose constituents are arranged in a highly ordered microscopic structure, forming a crystal lattice that extends in all directions. In addition, macroscopic single crystals are usually identifiable by their geometrical shape, consisting of flat faces with specific, characteristic orientations.",
                17: "The seat upon which a person holding the title King, Queen, Emperor, or Empress sits in a nation using a monarchy political system, although there are a few exceptions.",
                18: "A wise old turtle elder sits here, watching you with ancient eyes.",
                20: "A majestic sea dragon coils in the lair, its eyes glowing with wisdom. It seems to want something from you."
            };
            // Add lore for new NPCs
            if (currentRoom === 18) {
                text += "You see the Turtle Elder. Maybe you should TALK to him.";
            } else if (currentRoom === 10) {
                text += "A ghostly pirate captain floats here, his eyes glowing with lost purpose.";
            } else if (currentRoom === 20) {
                text += "The Sea Dragon is here, watching you intently.";
            } else if (currentRoom === 4) {
                text += "The ship's cook is here, busy with underwater ingredients.";
            } else if (currentRoom === 7) {
                text += "The mermaid glides through the water, her eyes meeting yours.";
            } else {
                text += examines[currentRoom] || "There is nothing special to examine here.";
            }
            setText(text);
        }
        
        function showInventory() {
            let text = "\n=== INVENTORY ===\n";
            if (inventory.length === 0) {
                text += "Your inventory is empty.";
            } else {
                text += "You are carrying:\n";
                inventory.forEach(item => {
                    text += `- ${item}\n`;
                });
            }
            setText(text);
        }
        
        function getItem() {
            // Prevent duplicate items in inventory
            let text = "\n=== GET ITEM ===\n";
            let found = false;
            for (let itemKey in items) {
                const item = items[itemKey];
                // Allow picking up any item that can be carried
                if (item.location === currentRoom && item.canCarry) {
                    if (!inventory.includes(item.name)) {
                        inventory.push(item.name);
                        item.location = -1;
                        text += `The item ${item.name} was placed in your inventory.`;
                    } else {
                        text += `You already have the ${item.name}.`;
                    }
                    found = true;
                    break;
                }
            }
            if (!found) {
                text += "There is no item to get here.";
            }
            setText(text);
        }
        
        function rest() {
            let text = "\n=== REST ===\n";
            
            const restMessages = {
                0: "You rest among the floating clothing. The life jackets make comfortable pillows.",
                1: "You rest near the roulette wheel. The seaweed sways gently, almost hypnotic.",
                2: "You try to rest but the strong current keeps pulling at you. This isn't a safe place!",
                3: "You rest in the hotel lobby. It's surprisingly peaceful for an underwater building.",
                4: "You take a break in the restaurant. If only there was real food here...",
                5: "You rest in the corridor. TheFuse narrow hallway echoes with distant water sounds.",
                6: "You rest among the stored items. It's quiet and secluded in here.",
                7: "You rest in the mermaid's chamber. The magical atmosphere fills you with wonder.",
                8: "You rest in the tranquil garden. The peaceful surroundings calm your nerves.",
                9: "You rest on the old ship. The creaking wood reminds you of its pirate past.",
                10: "You rest in the captain's quarters. A cold shiver runs down your spine.",
                11: "You rest at the highest point of the ship. The view is surprisingly peaceful.",
                12: "You rest on the slippery deck. The wood is worn but still sturdy.",
                13: "You rest in the dark cellar. The bones nearby make you uneasy...",
                14: "You rest surrounded by sparkling gems. Their beauty is mesmerizing.",
                15: "You rest near the treasure chest. Dreams of riches fill your mind.",
                16: "You rest among the crystals. The bright light makes it hard to relax.",
                17: "You rest near the throne, feeling the ancient power of this place.",
                18: "You rest with the sea turtles. They seem unbothered by your presence.",
                19: "This is NOT a good place to rest! The sharks are watching you!",
                20: "Are you crazy?! You can't rest in a dragon's lair! The egg radiates heat."
            };
            
            text += restMessages[currentRoom] || "You take a moment to rest and catch your breath.";
            setText(text);
        }
        
        function useItem() {
            if (inventory.length === 0) {
                setText("\n=== USE ITEM ===\nYou have nothing in your inventory, go find some items to use.");
                return;
            }
            const modal = document.getElementById('useItemModal');
            const itemList = document.getElementById('itemList');
            itemList.innerHTML = '';
            inventory.forEach((item) => {
                const btn = document.createElement('button');
                btn.className = 'item-button';
                btn.type = 'button';
                btn.setAttribute('aria-label', `Use ${item}`);
                btn.setAttribute('tabindex', '0');
                btn.textContent = item;
                btn.onclick = () => useSelectedItem(item);
                itemList.appendChild(btn);
            });
            modal.style.display = 'block';
        }
        
        function useSelectedItem(item) {
            closeModal();
            let text = `\n=== USE ITEM ===\nYou used the ${item}.\n`;
            const useMessages = {
                "KEY": "You need to be at a door to use the key. Try OPEN or CLOSE at the corridor.",
                "GHOST_KEY": "The ghostly key shimmers in your hand. It feels cold and ethereal, ready to unlock a spectral door.",
                "MAGNET": "The magnet pulls at nearby metal objects. It tingles in your hand.",
                "MONEY": "The money is too shriveled and waterlogged to spend anywhere.",
                "GEM": "The gem sparkles beautifully in your hand. It's quite valuable!",
                "CRYSTAL": "The crystal glows with an inner light. Its beauty is captivating.",
                "DRAGONEGG": "You hold the dragon egg carefully. It's warm to the touch. You hope the mother doesn't find out!",
                "TELESCOPE": "You look through the old telescope and see distant underwater landscapes and mysterious creatures.",
                "HAT": "You put on the captain's hat. You feel like a true pirate! Arr matey!",
                "SEAWEED": "You nibble on the seaweed. It's not very tasty, but it fills your belly.",
                "ROPE": "You test the rope's strength. It could be useful for climbing or tying things.",
                "CHEST": "You try to open the chest, but it's locked tight. Maybe there's a key somewhere.",
                "LIFEJACKET": "You put on the lifejacket. It feels odd to wear underwater, but you feel a bit safer.",
                "BONES": "You examine the bones. They send a chill down your spine.",
                "THRONE": "You sit on the throne for a moment, feeling regal.",
                "MERMAID": "The mermaid smiles at you. She seems pleased to see you using your items.",
                "TURTLE_ELDER": "The Turtle Elder nods wisely as you show him your item.",
                "PIRATE_GHOST": "The Pirate Ghost grins, his eyes gleaming with approval.",
                "SEA_DRAGON": "The Sea Dragon watches you intently, its gaze full of ancient wisdom.",
                "COOK": "The Cook sniffs your item, wondering if it could be used in a new recipe."
            };
            if (item === "HAT" && !pirateQuestComplete) {
                pirateGhostMad = true;
                text += "\nAs you put on the hat, you feel a chill in the air... Did someone see you? The Pirate Ghost looks angry that you took his hat without permission! ";
            }
            text += useMessages[item] || "Nothing special happens when you use this item.";
            setText(text);
        }
        
        function closeModal() {
            document.getElementById('useItemModal').style.display = 'none';
        }
        
        function openDoor() {
            let text = "\n=== OPEN ===\n";
            
            if (currentRoom === 5 || currentRoom === 6) {
                if (inventory.includes("KEY")) {
                    doorOpen = true;
                    text += "You use the rusty key to unlock the door. The door is now open.";
                } else {
                    text += "The door is locked. You need a key to open it.";
                }
            } else if (currentRoom === 13 || currentRoom === 12) {
                if (inventory.includes("GHOST_KEY")) {
                    cellarOpen = true;
                    text += "You use the ghostly key to unlock the cellar door. The spectral lock fades away.";
                } else {
                    text += "The cellar door is locked. You need a ghostly key to open it.";
                }
            } else {
                text += "Opening that is not possible.";
            }
            
            setText(text);
        }
        
        function closeDoor() {
            let text = "\n=== CLOSE ===\n";
            
            if (currentRoom === 5 || currentRoom === 6) {
                if (inventory.includes("KEY")) {
                    doorOpen = false;
                    text += "You use the key to lock the door. The door is now closed.";
                } else {
                    text += "You need the key to lock the door.";
                }
            } else if (currentRoom === 13 || currentRoom === 12) {
                if (inventory.includes("GHOST_KEY")) {
                    cellarOpen = false;
                    text += "You use the ghostly key to lock the cellar door. The spectral lock returns.";
                } else {
                    text += "You need the ghostly key to lock the cellar door.";
                }
            } else {
                text += "Closing that is not possible.";
            }
            
            setText(text);
        }
        
        function sitStand() {
            let text = "\n=== SIT/STAND ===\n";
            
            if (isSitting) {
                isSitting = false;
                text += "You stand up and are ready to move again.";
            } else if (currentRoom === 17) {
                isSitting = true;
                text += "You sit on the throne. The ancient power fills you with passion!\n";
                text += "Press SIT/STAND again to get up.";
            } else {
                text += "There is no place to sit here.";
            }
            
            setText(text);
        }
        
        function talk() {
            let text = "\n=== TALK ===\n";
            // Mermaid (room 7)
            if (currentRoom === 7) {
                const mermaidLore = [
                    "Mermaid: 'Welcome, land dweller! You got your style, now let it shine through, and remember no matter what, you got to be you.'",
                    "Mermaid: 'You seem brave to venture so deep underwater. Are you searching for something special?'",
                    "Mermaid: 'I've lived in these waters for centuries. I've seen many treasures and dangers alike.'",
                    "Mermaid: 'Beware the shark grove to the east. Many adventurers have not returned from there.'",
                    "Mermaid: 'The King's Room holds ancient power. Sit upon the throne if you dare!'",
                    "Mermaid: 'I hear a sea dragon guards something precious in the southern waters. Would you be brave enough to face it?'",
                    "Mermaid: 'The sunken ship to the north holds secrets from the pirate age. The captain was quite fearsome!'",
                    "Mermaid: 'Have you found the key yet? It unlocks many mysteries in this underwater realm.'",
                    "Mermaid: 'The turtles in their palace are gentle creatures. They've seen much in their long lives.'",
                    "Mermaid: 'You remind me of the old marine biology students who used to explore these waters.'",
                    "Mermaid: 'You're quite persistent! I like that about you. Perhaps we can be friends after all.'"
                ];
                text += mermaidLore[(mermaidDialogueCount % mermaidLore.length)] + "\n";
                mermaidDialogueCount++;
            // Turtle Elder (room 18)
            } else if (currentRoom === 18) {
                const turtleLore = [
                    "Turtle Elder: 'Welcome, young one. The tides have brought you far.'",
                    "Turtle Elder: 'Patience is the greatest wisdom. Even the slowest can reach their destination.'",
                    "Turtle Elder: 'The palace has stood for centuries, sheltering many generations.'",
                    "Turtle Elder: 'The garden is a place of peace. Many secrets are hidden among the plants.'",
                    "Turtle Elder: 'Beware the shark grove. Even turtles avoid it.'",
                    "Turtle Elder: 'The king's throne is not for everyone. Only the worthy may sit.'",
                    "Turtle Elder: 'Legends say the sea dragon once visited our palace.'",
                    "Turtle Elder: 'The merfolk are wise and kind. Have you met the mermaid?'",
                    "Turtle Elder: 'A true friend is a treasure greater than any gem.'",
                    "Turtle Elder: 'You remind me of a young turtle who dreamed of adventure.'",
                    "Turtle Elder: 'Return often, traveler. The palace doors are always open to you.'"
                ];
                text += turtleLore[(turtleDialogueCount % turtleLore.length)] + "\n";
                turtleDialogueCount++;
            // Pirate Ghost (room 10)
            } else if (currentRoom === 10) {
                if (pirateGhostMad) {
                    text += "Pirate Ghost: 'I saw ye wearin' me hat! That hat be precious to me. Return it, and maybe I'll forgive ye.'\n";
                } else {
                    const pirateLore = [
                        "Pirate Ghost: 'Arrr! The sea be full of mysteries and lost souls.'",
                        "Pirate Ghost: 'I once sailed these waters with a fearless crew.'",
                        "Pirate Ghost: 'Beware the cursed treasure. Not all gold brings happiness.'",
                        "Pirate Ghost: 'The captain's hat is a symbol of honor. Treat it well.'",
                        "Pirate Ghost: 'The deck hides secrets for those who look closely.'",
                        "Pirate Ghost: 'The mermaid knows more than she lets on.'",
                        "Pirate Ghost: 'I miss the taste of rum and the thrill of a storm.'",
                        "Pirate Ghost: 'The king's room was once the site of a great battle.'",
                        "Pirate Ghost: 'Even in death, I guard my ship.'",
                        "Pirate Ghost: 'The sea dragon and I were rivals in another life.'",
                        "Pirate Ghost: 'You have the spirit of a true adventurer.'"
                    ];
                    text += pirateLore[(pirateDialogueCount % pirateLore.length)] + "\n";
                    pirateDialogueCount++;
                }
            // Sea Dragon (room 20)
            } else if (currentRoom === 20) {
                const dragonLore = [
                    "Sea Dragon: 'The deep currents whisper secrets to those who listen.'",
                    "Sea Dragon: 'I have seen empires rise and fall beneath the waves.'",
                    "Sea Dragon: 'My lair is a place of power and solitude.'",
                    "Sea Dragon: 'The gem room sparkles, but true treasure is wisdom.'",
                    "Sea Dragon: 'Beware the sharks. Even dragons respect their hunger.'",
                    "Sea Dragon: 'The mermaid once sang a song that calmed the storms.'",
                    "Sea Dragon: 'The turtle elder is older than even I.'",
                    "Sea Dragon: 'Legends say a king once rode a dragon into battle.'",
                    "Sea Dragon: 'The pirate ghost and I have unfinished business.'",
                    "Sea Dragon: 'You are braver than most who visit my lair.'",
                    "Sea Dragon: 'Return with knowledge, and you may earn my respect.'"
                ];
                text += dragonLore[(dragonDialogueCount % dragonLore.length)] + "\n";
                dragonDialogueCount++;
            // Ship's Cook (room 4)
            } else if (currentRoom === 4) {
                const cookLore = [
                    "Cook: 'A pinch of sea salt makes every dish better.'",
                    "Cook: 'I've cooked for pirates, kings, and merfolk alike.'",
                    "Cook: 'The best stew is made with fresh seaweed from the garden.'",
                    "Cook: 'Beware the sharks if you go foraging.'",
                    "Cook: 'The mermaid once gave me a recipe for happiness.'",
                    "Cook: 'The turtle elder prefers his soup slow-cooked.'",
                    "Cook: 'The sea dragon likes his meals spicy.'",
                    "Cook: 'The pirate ghost always wanted extra rum in his stew.'",
                    "Cook: 'The king's room once hosted grand feasts.'",
                    "Cook: 'You look hungry! Stay for a meal.'",
                    "Cook: 'Come back anytime, friend. Thereâ€™s always a place at my table.'"
                ];
                text += cookLore[(cookDialogueCount % cookLore.length)] + "\n";
                cookDialogueCount++;
            } else {
                text += "There is nobody to talk with here.";
            }
            setText(text);
        }

        function takeQuest() {
            let text = "\n=== QUEST ===\n";
            // Mermaid quest (CRYSTAL)
            if (currentRoom === 7 && !mermaidQuestStarted) {
                mermaidQuestStarted = true;
                text += "The mermaid glides closer, her voice shimmering: 'Adventurer, would you bring me a rare CRYSTAL from the crystal room? Its light would brighten my collection and my heart.'";
            } else if (currentRoom === 7 && mermaidQuestStarted && !mermaidQuestComplete) {
                text += "Mermaid: 'Have you found the CRYSTAL yet? Its glow is said to rival the stars above. Please, bring it to me from the crystal room.'";
            } else if (currentRoom === 7 && mermaidQuestComplete) {
                text += "Mermaid: 'You have already brought me the CRYSTAL, dear friend. My gratitude is as deep as the sea.'";
            }
            // Turtle quest (GEM)
            else if (currentRoom === 18 && !turtleQuestStarted) {
                turtleQuestStarted = true;
                text += "The Turtle Elder speaks slowly: 'Young traveler, my precious GEM is lost in the gem room. Would you help an old turtle and return it to me?'";
            } else if (currentRoom === 18 && turtleQuestStarted && !turtleQuestComplete) {
                text += "Turtle Elder: 'Patience and persistence, young one. The GEM from the gem room awaits your steady hand.'";
            } else if (currentRoom === 18 && turtleQuestComplete) {
                text += "Turtle Elder: 'You have already returned my GEM. May wisdom guide your path.'";
            }
            // Pirate quest (HAT)
            else if (currentRoom === 10 && !pirateQuestStarted) {
                pirateQuestStarted = true;
                if (pirateGhostMad) {
                    text += "The Pirate Ghost's eyes narrow: 'Ye dare wear me hat before returning it? That be a bold move, matey! Bring it here, and maybe I'll forgive yer insolence.'";
                } else {
                    text += "The Pirate Ghost bellows: 'Arrr! Me hat be missin', lost in the sunken ship. Fetch it for me, and I'll owe ye a favor, matey!'";
                }
            } else if (currentRoom === 10 && pirateQuestStarted && !pirateQuestComplete) {
                if (pirateGhostMad) {
                    text += "Pirate Ghost: 'I see ye have me hat... but it belongs to me! Return it now, and perhaps I'll not haunt ye forever!'";
                } else {
                    text += "Pirate Ghost: 'Still no sign of me hat? It's somewhere in the sunken ship. Don't keep a restless spirit waitin'!'";
                }
            } else if (currentRoom === 10 && pirateQuestComplete) {
                text += "Pirate Ghost: 'Ye already returned me hat, matey. I'll not forget yer kindness!'";
            }
            // Dragon quest (DRAGONEGG)
            else if (currentRoom === 20 && !dragonQuestStarted) {
                dragonQuestStarted = true;
                text += "The Sea Dragon's voice rumbles: 'A DRAGONEGG was stolen from my lair and hidden in the cellar. Prove your courageâ€”return it to me.'";
            } else if (currentRoom === 20 && dragonQuestStarted && !dragonQuestComplete) {
                text += "Sea Dragon: 'The DRAGONEGG is still missing. Seek it in the cellar and return it to its rightful place.'";
            } else if (currentRoom === 20 && dragonQuestComplete) {
                text += "Sea Dragon: 'You have already returned the DRAGONEGG. My respect is yours.'";
            }
            // Cook quest (SEAWEED)
            else if (currentRoom === 4 && !cookQuestStarted) {
                cookQuestStarted = true;
                text += "The Cook waves a ladle: 'Ahoy, friend! I need the freshest SEAWEED from the garden for my legendary stew. Can you fetch it for me?'";
            } else if (currentRoom === 4 && cookQuestStarted && !cookQuestComplete) {
                text += "Cook: 'Still no SEAWEED? My stew won't be the same without it! Please, bring some from the garden.'";
            } else if (currentRoom === 4 && cookQuestComplete) {
                text += "Cook: 'You've already brought me the SEAWEED! The stew is a masterpiece, thanks to you.'";
            } else {
                text += "There is no quest available for you here.";
            }
            setText(text);
        }
        
        function move(direction) {
            // Improved: auto-look after move, accessibility
            if (!gameStarted) {
                setText("\nPlease click LOOK to begin your adventure first!");
                return;
            }
            if (isSitting) {
                setText("\nYou can't move while sitting! Press SIT/STAND to get up first.");
                return;
            }
            const nextRoom = roomConnections[currentRoom][direction];
            if (nextRoom !== -1) {
                // Storage room door logic
                if ((currentRoom === 5 && nextRoom === 6 && !doorOpen) ||
                    (currentRoom === 6 && nextRoom === 5 && !doorOpen)) {
                    setText("\nThe door is locked. You need to find a way to open it.");
                    return;
                }
                // Cellar door logic
                if ((currentRoom === 12 && nextRoom === 13 && !cellarOpen) ||
                    (currentRoom === 13 && nextRoom === 12 && !cellarOpen)) {
                    setText("\nThe cellar door is locked. You need a ghostly key to open it.");
                    return;
                }
                currentRoom = nextRoom;
                lookAround(); // Show new room info automatically
            } else {
                const dirNames = ["NORTH", "SOUTH", "EAST", "WEST"];
                setText(`\nYou can't go ${dirNames[direction]} from ${rooms[currentRoom]}.`);
            }
        }
        
        // === INITIALIZE GAME ===
        showIntroduction();
        // End of improvements and comments are in code above
    </script>
</body>
</html>