<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Underwater Adventure Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(to bottom, #001a33, #003d5c);
            color: #fff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow: hidden;
        }

        .page-wrapper {
            height: 720px;
            overflow: hidden;
            position: relative;
        }

        .scroll-container {
            height: 100%;
            overflow-y: hidden;
            position: relative;
        }

        .content-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            transition: top 0.3s ease;
        }

        .scroll-control {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            height: 500px;
            width: 20px;
        }

        .scroll-slider {
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            writing-mode: bt-lr;
            width: 20px;
            height: 100%;
            cursor: pointer;
            background: rgba(0, 128, 255, 0.3);
            border-radius: 10px;
            outline: none;
        }

        .scroll-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            border: 2px solid #00ccff;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.8);
        }

        .scroll-slider::-moz-range-thumb {
            width: 30px;
            height: 80px;
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            border: 2px solid #00ccff;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 204, 255, 0.8);
        }

        .scroll-slider::-webkit-slider-thumb:hover {
            background: linear-gradient(to bottom, #00ffff, #00ccff);
            box-shadow: 0 0 15px rgba(0, 255, 255, 1);
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: rgba(0, 40, 80, 0.8);
            border: 2px solid #0080ff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 128, 255, 0.5);
            min-height: 1200px;
        }

        h1 {
            text-align: center;
            color: #00ccff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ccff;
        }

        .audio-controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .audio-controls button {
            width: 120px;
            margin: 0 5px;
        }

        .close-x {
            position: absolute;
            top: 10px;
            right: 15px;
            background: transparent;
            border: none;
            color: #ff4444;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
        }

        .volume-control {
            display: inline-block;
            margin-left: 10px;
        }

        .volume-control input {
            width: 100px;
            vertical-align: middle;
        }

        #textArea {
            width: 100%;
            height: 300px;
            background: #001a33;
            color: #00ff88;
            border: 2px solid #0080ff;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-y: scroll;
            white-space: pre-wrap;
            margin-bottom: 20px;
        }

        .movement-panel {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .action-panel {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            background: linear-gradient(to bottom, #0080ff, #0050cc);
            color: white;
            border: 2px solid #00ccff;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 12px;
        }

        button:hover {
            background: linear-gradient(to bottom, #00ccff, #0080ff);
            box-shadow: 0 0 15px #00ccff;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .movement-panel button {
            padding: 15px;
            font-size: 14px;
        }

        .empty-cell {
            background: transparent;
            border: none;
        }

        .empty-cell:hover {
            background: transparent;
            box-shadow: none;
            transform: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: linear-gradient(to bottom, #001a33, #003d5c);
            margin: 15% auto;
            padding: 20px;
            border: 2px solid #00ccff;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
        }

        .modal-content h2 {
            color: #00ccff;
            margin-bottom: 15px;
        }

        .item-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .item-button {
            width: 100%;
            margin: 5px 0;
            text-align: left;
        }

        .close-modal {
            background: #cc0000;
            border-color: #ff0000;
        }

        @media (max-width: 768px) {
            .action-panel {
                grid-template-columns: repeat(2, 1fr);
            }

            button {
                font-size: 10px;
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <div class="scroll-container">
            <div class="content-wrapper" id="contentWrapper">
                <div class="container">
                    <h1>üåä UNDERWATER ADVENTURE üåä</h1>

                    <div class="audio-controls">
                        <button type="button" onclick="toggleMusic()" id="musicToggle"
                            aria-label="Toggle background music" tabindex="0">üîä Music: ON</button>
                        <div class="volume-control">
                            <label for="volumeSlider">Volume: </label>
                            <input type="range" id="volumeSlider" min="0" max="100" value="30"
                                oninput="changeVolume(this.value)" aria-label="Music volume" tabindex="0">
                            <span id="volumeDisplay">30%</span>
                        </div>
                    </div>

                    <div id="textArea"></div>

                    <div class="movement-panel">
                        <button class="empty-cell" disabled aria-hidden="true"></button>
                        <button type="button" onclick="move(0)" aria-label="Move North" tabindex="0">NORTH</button>
                        <button class="empty-cell" disabled aria-hidden="true"></button>
                        <button type="button" onclick="move(3)" aria-label="Move West" tabindex="0">WEST</button>
                        <button type="button" onclick="move(1)" aria-label="Move South" tabindex="0">SOUTH</button>
                        <button type="button" onclick="move(2)" aria-label="Move East" tabindex="0">EAST</button>
                    </div>

                    <div class="action-panel">
                        <button type="button" onclick="showQuestTracker()" aria-label="Show quest tracker"
                            tabindex="0">QUEST TRACKER</button>
                        <button onclick="returnHome()" id="returnHomeBtn" style="display:none;">RETURN HOME</button>
                        <button type="button" onclick="getItem()" aria-label="Get item" tabindex="0">GET</button>
                        <button type="button" onclick="rest()" aria-label="Rest" tabindex="0">REST</button>
                        <button type="button" onclick="useItem()" aria-label="Use item" tabindex="0">USE</button>
                        <button type="button" onclick="openDoor()" aria-label="Open door" tabindex="0">OPEN</button>
                        <button type="button" onclick="closeDoor()" aria-label="Close door" tabindex="0">CLOSE</button>
                        <button type="button" onclick="examine()" aria-label="Examine" tabindex="0">EXAMINE</button>
                        <button type="button" onclick="showInventory()" aria-label="Show inventory"
                            tabindex="0">INVENTORY</button>
                        <button type="button" onclick="lookAround()" aria-label="Look around" tabindex="0">LOOK</button>
                        <button type="button" onclick="sitStand()" aria-label="Sit or stand"
                            tabindex="0">SIT/STAND</button>
                        <button type="button" onclick="talk()" aria-label="Talk" tabindex="0">TALK</button>
                        <button type="button" onclick="takeQuest()" aria-label="Take quest" tabindex="0">TAKE
                            QUEST</button>
                        <button type="button" onclick="giveItem()" aria-label="Give item" tabindex="0">GIVE
                            ITEM</button>
                        <button type="button" onclick="showMap()" aria-label="Show map" tabindex="0"
                            style="background: linear-gradient(to bottom, #00ccff, #0050cc);">MAP</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Scroll Controls -->
        <div class="scroll-control">
            <input type="range" class="scroll-slider" id="scrollSlider" min="0" max="100" value="0" orient="vertical"
                oninput="scrollToPosition(this.value)">
        </div>

        <div id="useItemModal" class="modal" aria-modal="true" role="dialog">
            <div class="modal-content">
                <button class="close-x" onclick="closeModal()" aria-label="Close use item modal">√ó</button>
                <h2>Select Item to Use</h2>
                <div id="itemList" class="item-list"></div>
                <button class="close-modal" onclick="closeModal()" aria-label="Cancel use item">Cancel</button>
            </div>
        </div>

        <!-- Map Modal -->
        <div id="mapModal" class="modal" aria-modal="true" role="dialog">
            <div class="modal-content"
                style="max-width: 90%; width: fit-content; max-height: 90vh; overflow: auto; margin: 10px auto; position: relative;">
                <button class="close-x" onclick="closeMapModal()" aria-label="Close map modal">√ó</button>
                <h2>Underwater Navigation Map</h2>
                <div
                    style="overflow: auto; background: #001a33; padding: 10px; border-radius: 5px; border: 1px solid #0080ff; max-height: 70vh;">
                    <pre id="mapContent"
                        style="font-size: 12px; line-height: 14px; color: #00ff88; margin: 0; white-space: pre; word-break: break-all;"></pre>
                </div>
                <button class="close-modal" onclick="closeMapModal()" aria-label="Close map"
                    style="margin-top: 15px;">Close Map</button>
            </div>
        </div>

        <!-- Quest Tracker Modal -->
        <div id="questTrackerModal" class="modal" aria-modal="true" role="dialog">
            <div class="modal-content"
                style="max-width: 90%; width: fit-content; max-height: 90vh; overflow: auto; margin: 10px auto;">
                <button class="close-x" onclick="closeQuestTrackerModal()"
                    aria-label="Close quest tracker modal">√ó</button>
                <h2>üåä QUEST TRACKER üåä</h2>
                <div id="questList"
                    style="max-height: 70vh; overflow-y: auto; text-align: left; padding: 15px; background: rgba(0, 30, 60, 0.8); border-radius: 5px; border: 1px solid #0080ff;">
                    <!-- Quests will be populated here -->
                </div>
                <button class="close-modal" onclick="closeQuestTrackerModal()" aria-label="Close quest tracker"
                    style="margin-top: 15px;">Close Tracker</button>
            </div>
        </div>

        <audio id="backgroundMusic" loop>
            <!-- Add your music file here. Place the file in the same folder as this HTML -->
            <source src="underwater_theme.mp3" type="audio/mpeg">
            <source src="underwater_theme.wav" type="audio/wav">
            <source src="underwater_theme.ogg" type="audio/ogg">
        </audio>

        <script>
            // === GAME STATE VARIABLES ===
            let mermaidDialogueCount = 0;
            let turtleDialogueCount = 0;
            let pirateDialogueCount = 0;
            let dragonDialogueCount = 0;
            let cookDialogueCount = 0;
            let isSitting = false;
            let currentRoom = 2;
            let doorOpen = false;
            let cellarOpen = false; // Tracks if the cellar is unlocked
            let gameStarted = false;
            let inventory = [];
            let musicPlaying = false;
            let currentScrollPosition = 0;
            let maxScroll = 0;
            // Quest state
            let mermaidQuestStarted = false;
            let mermaidQuestComplete = false;
            let turtleQuestStarted = false;
            let turtleQuestComplete = false;
            let pirateQuestStarted = false;
            let pirateQuestComplete = false;
            let pirateGhostMad = false; // Tracks if ghost is mad about hat
            let dragonQuestStarted = false;
            let dragonQuestComplete = false;
            let cookQuestStarted = false;
            let cookQuestComplete = false;
            let seaweedUsed = false; // ADD THIS LINE

            // Shark quest variables
            let sharkQuestStarted = false;
            let sharkQuestComplete = false;
            let sharkPlushUsed = false;
            let sharkDialogueCount = 0;

            // Ending system variables
            let allQuestsComplete = false;
            let gameEnded = false;
            let companionChosen = null;
            let cookGivenUsedSeaweed = false; // Track if player ever tried to give used seaweed
            // New NPC quest variables
            let designerQuestStarted = false;
            let designerQuestComplete = false;
            let kingQuestStarted = false;
            let kingQuestComplete = false;
            let gamblerQuestStarted = false;
            let gamblerQuestComplete = false;
            let crewQuestStarted = false;
            let crewQuestComplete = false;
            let designerDialogueCount = 0;
            let kingDialogueCount = 0;
            let gamblerDialogueCount = 0;
            let crewDialogueCount = 0;
            let satOnThroneBeforeKingQuest = false; // Track if player sat on throne
            let silkObtained = false; // Track if player got silk from dragon

            // New NPC quest variables
            let squidAsleep = false; // Track if squid is blocking or asleep
            let squidDialogueCount = 0;
            let sealQuestStarted = false;
            let sealQuestComplete = false;
            let sealDialogueCount = 0;
            let tikoQuestStarted = false;
            let tikoQuestComplete = false;
            let tikoDialogueCount = 0;
            let grandpaFound = false; // Track if player found Turtle Elder for Tiko

            // === ASCII MAP ===
            const asciiMap = `
                     *---------------*     *---------------*                           *---------------*          
                     |  Under Water  |     |     Aqua      |                           |               |          
                     |    Casino     |     |   Clothing    |                           |   Crows Nest  |                           
                     |               |     |     shop      |                           |               |
                     *---------------*     *---------------*                           *---------------*
                         |     |               |     |                                       |   |
                         |     |               |     |                                       |   |  
                         |     |               |     |                                       |   |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*     *---------------*          
|  Under Water  |____|  Under Water  |_____|      Sea      |_____|               |_____|               |_____|               |          
|   Restaurant  |    |     Lobby     |     | Cave Entrance |     |  Sunken Ship  |     |      Deck     |     |  Captins Room |                           
|               |____|               |_____|               |_____|               |_____|               |-----|               |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*     *---------------*    
                         |      |              |     |                |     |                |    |
                         |      |              |     |                |     |           *---------------*              
                         |      |              |     |                |     |           |               |               
                         |      |              |     |                |     |           |    Cellar     |                           
                         |      |              |     |                |     |           |               |     
                         |      |              |     |                |     |           *---------------*
                         |      |              |     |                |     |                      
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*          
|  Under Water  |____|  Under Water  |     |     Shark     |_____|  Under Water  |_____|     Turtle    |          
|  Storage Room |    |   Corridor    |     |     Grove     |     |    Garden     |     |     Palace    |                           
|               |____|               |     |               |_____|               |_____|               |
*---------------*    *---------------*     *---------------*     *---------------*     *---------------*             
                                                 |   |                |     |
                                                 |   |                |     |
                                                 |   |                |     |
                                           *---------------*     *---------------*              
                                           |   Sea Dragon  |     |               |               
                                           |     Lair      |     | Mermaid Room  |                           
                                           |               |     |               |     
                                           *---------------*     *---------------*     
                                                                     |      |
                                                                     |      |
                                           *---------------*     *---------------*     *---------------*          
                                           |               |_____|               |_____|               |          
                                           |  Gem Rooom    |     |  Kings Room   |     | Crystal Room  |                           
                                           |               |_____|               |_____|               |
                                           *---------------*     *---------------*     *---------------*
                                                                       |   |
                                                                       |   | 
                                                                       |   |
                                                                 *---------------*              
                                                                 |   Tressure    |               
                                                                 |     Room      |                           
                                                                 |               |     
                                                                 *---------------*`;

            // === ACCESSIBILITY & MODAL UX ===
            // Improved: close modal on background click, only if visible
            window.addEventListener('click', function (event) {
                const itemModal = document.getElementById('useItemModal');
                const mapModal = document.getElementById('mapModal');
                const questModal = document.getElementById('questTrackerModal');
                if (event.target === itemModal && itemModal.style.display === 'block') {
                    itemModal.style.display = 'none';
                }
                if (event.target === mapModal && mapModal.style.display === 'block') {
                    mapModal.style.display = 'none';
                }
                if (event.target === questModal && questModal.style.display === 'block') {
                    questModal.style.display = 'none';
                }
            });

            // === SCROLL BAR LOGIC ===
            // Debounced resize for performance
            window.addEventListener('load', calculateMaxScroll);
            window.addEventListener('resize', debounce(calculateMaxScroll, 100));
            function calculateMaxScroll() {
                const wrapper = document.getElementById('contentWrapper');
                const container = document.querySelector('.page-wrapper');
                maxScroll = Math.max(0, wrapper.offsetHeight - container.offsetHeight);
            }
            function scrollToPosition(value) {
                currentScrollPosition = (value / 100) * maxScroll;
                const wrapper = document.getElementById('contentWrapper');
                wrapper.style.top = `-${currentScrollPosition}px`;
            }
            function debounce(fn, ms) {
                let timer;
                return function (...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), ms);
                };
            }

            // === MAP MODAL ===
            function showMap() {
                document.getElementById('mapContent').textContent = asciiMap;
                document.getElementById('mapModal').style.display = 'block';
            }
            function closeMapModal() {
                document.getElementById('mapModal').style.display = 'none';
            }

            // === GAME DATA ===
            // Use const for immutable data
            const rooms = [
                "Aquatic Clothing Shop", "Underwater Casino", "Underwater Cave (Car Park)",
                "Underwater Lobby", "Underwater Restaurant", "Underwater Corridor",
                "Underwater Storage Room", "Mermaid Room", "Underwater Garden", "Sunken Ship",
                "Captain's Room", "Crow's Nest", "Deck", "Cellar", "Gem Room", "Treasure Room",
                "Crystal Room", "King's Room", "Turtle Palace", "Shark Grove", "Sea Dragon's Lair"
            ];

            const roomConnections = [
                [-1, 2, -1, -1],   // 0: Aquatic Clothing Shop
                [-1, 3, -1, -1],   // 1: Casino
                [0, 19, 9, 3],     // 2: Carpark
                [1, 5, 2, 4],      // 3: Lobby
                [-1, -1, 3, -1],   // 4: Restaurant
                [3, -1, -1, 6],    // 5: Corridor
                [-1, -1, 5, -1],   // 6: Storage Room
                [8, 17, -1, -1],   // 7: Mermaid Room
                [9, 7, 18, 19],    // 8: Garden
                [-1, 8, 12, 2],    // 9: Sunken Ship
                [-1, -1, -1, 12],  // 10: Captain's Room
                [-1, 12, -1, -1],  // 11: Crow's Nest
                [11, 13, 10, 9],   // 12: Deck
                [12, -1, -1, -1],  // 13: Cellar
                [-1, -1, 17, -1],  // 14: Gem Room
                [17, -1, -1, -1],  // 15: Treasure Room
                [-1, -1, -1, 17],  // 16: Crystal Room
                [7, 15, 16, 14],   // 17: King's Room
                [-1, -1, -1, 8],   // 18: Turtle Palace
                [2, 20, 8, -1],    // 19: Shark Grove
                [19, -1, -1, -1]   // 20: Sea Dragon's Lair
            ];

            const roomDescriptions = {
                0: "Aquatic clothing shop",
                1: "Under water seaweed infested casino",
                2: "Under water cave, the current is pulling you, choose if you dare",
                3: "Under water hotel lobby",
                4: "Under water restaurant",
                5: "Under water corridor",
                6: "Under water store room",
                7: "Mermaid Room",
                8: "Tranquil under water garden",
                9: "Sunken ship",
                10: "Captain's room that used to be a pirate's! You feel a cold shiver down your spine while gazing into the room",
                11: "Crow's nest, the top of the sunken ship, you think it might be a steep height but you realize that you are still under water",
                12: "Sunken ship's deck, which makes you recall the time that you were sea sick and how slippery the wood was on your feet when walking on it, however you realize that neither of these things apply here since you're under the water",
                13: "Cold dark cellar under some worn wooden boards, do you think it's abandoned? For your case let's hope so",
                14: "Gem room, with all the sparkling light it's practically pulling you in",
                15: "Hidden treasure room, there might even be a treasure chest who knows?",
                16: "Crystal room, right next to a gem room who would have guessed? Not me",
                17: "King's room with a throne in the middle, you think to yourself could this be your destiny?",
                18: "Palace where a bunch of sea turtles have made home in, would you want to disturb their peace? I mean go right ahead I am sure they're ok with outsiders",
                19: "Grove that is infested with sharks, who would have thought of all places. Well you could turn back now but some of them are eyeing you, might as well swim through, nothing could go wrong..",
                20: "Sea dragon's lair which might not be the best idea since you just risked your life swimming through a grove of sharks but who am I to tell you no"
            };

            const items = {
                "ANCIENT_PEARL": { name: "ANCIENT_PEARL", description: "an ancient pearl that has been passed down through generations of turtles, glowing with inner light", location: -1, canCarry: true }, // Given by Turtle Elder
                "GIANT_SQUID": { name: "GIANT_SQUID", description: "a massive, iridescent squid coiled around the ship's mast, ink clouds swirling defensively", location: 9, canCarry: false },
                "SEAL": { name: "SEAL", description: "a nervous fur seal in a slightly crooked kelp bowtie, pacing anxiously", location: 3, canCarry: false },
                "TIKO": { name: "TIKO", description: "a tiny turtle hatchling with oversized flippers, clutching a faded seaweed map and sniffling", location: 2, canCarry: true },
                "SINGING_SHELL": { name: "SINGING_SHELL", description: "a beautiful shell that hums with a soothing lullaby", location: -1, canCarry: true }, // Given by Mermaid
                "SHARKPLUSH": { name: "SHARKPLUSH", location: 6, description: "A soft, well-loved shark plushie. It looks very precious to someone.", canCarry: true },
                "GHOST_KEY": { name: "GHOST_KEY", description: "a spectral key shimmering with ghostly light, said to unlock the cellar", location: -1, canCarry: true }, // Given by Pirate Ghost
                "DOOR": { name: "DOOR", description: "a closed store room door", location: 5, canCarry: false },
                "CELLAR_DOOR": { name: "CELLAR_DOOR", description: "a heavy cellar door with a ghostly lock", location: 13, canCarry: false },
                "MAGNET": { name: "MAGNET", description: "a magnet floating in the glimmering water", location: 3, canCarry: true },
                "KEY": { name: "KEY", description: "a rusty old key that looks like it might open something", location: -1, canCarry: true },
                "METER": { name: "METER", description: "a sunken parking meter filled with water", location: 2, canCarry: false },
                "ROULETTE": { name: "ROULETTE", description: "a floating roulette wheel in the water", location: 1, canCarry: false },
                "MONEY": { name: "MONEY", description: "some shriveled money drifting in the water", location: 1, canCarry: true },
                "LIFEJACKET": { name: "LIFEJACKET", description: "a life jacket... under water? Yeah, I've seen everything", location: 0, canCarry: false },
                "GEM": { name: "GEM", description: "some gems dug into the floor of the cavern, I don't think they look edible yet your belly roars as you gaze upon them, maybe you should have stopped to eat before scuba diving", location: 14, canCarry: true }, // Gem Room
                "CRYSTAL": { name: "CRYSTAL", description: "the sheer shine of the bright light is enough to blind you and maybe you should stop staring... hey! I said stop", location: 16, canCarry: true }, // Crystal Room
                "DRAGONEGG": { name: "DRAGONEGG", description: "an egg of a dragon laid on the floor, it wouldn't lead to conflict at all if you take it right? Is what you think to yourself yet you already have your hands around it", location: 13, canCarry: true }, // Cellar
                "HAT": { name: "HAT", description: "a captain's hat, might as well put it on", location: -1, canCarry: true }, // Sunken Ship
                "SEAWEED": { name: "SEAWEED", description: "finally some food... wait a minute this is just sea weed and I thought this was a 5 star restaurant", location: 8, canCarry: true }, // Garden
                "SILK": { name: "SILK", description: "shimmering silk from a dragon's mane, incredibly rare and valuable", location: -1, canCarry: true }, // Given by dragon
                "ROYAL_CLOTHES": { name: "ROYAL_CLOTHES", description: "exquisite royal garments fit for a king", location: -1, canCarry: true }, // Given by designer
                // Update existing items:
                "TELESCOPE": { name: "TELESCOPE", description: "an old telescope from the age of pirates maybe you can find your destiny of your adventure by looking through it", location: 11, canCarry: true }, // Changed from canCarry: false

                // Add NPCs to items:
                "DESIGNER": { name: "DESIGNER", description: "a skilled clothing designer carefully working on fine garments", location: 0, canCarry: false },
                "GAMBLER": { name: "GAMBLER", description: "a desperate gambler staring at the roulette wheel with hollow eyes", location: 1, canCarry: false },
                "CREW_MEMBER": { name: "CREW_MEMBER", description: "a weathered crew member gazing wistfully at the sky above", location: 12, canCarry: false },
                "KING": { name: "KING", description: "a regal king standing beside his throne, looking quite displeased", location: 17, canCarry: false },
                "ROPE": { name: "ROPE", description: "some rope seems to have fallen off the mast of the ship you could pick it up if you want nobody is stopping you", location: 12, canCarry: true },
                "BONES": { name: "BONES", description: "the bones of a fallen pirate in battle, definitely not creepy at all", location: 13, canCarry: false },
                "CHEST": { name: "CHEST", description: "a chest of treasures on a platform in the middle of the room, we haven't seen this before. You should just go pick it up", location: 15, canCarry: true },
                "THRONE": { name: "THRONE", description: "a throne in the middle of the room, might as well be yours you have earned it after making this adventure", location: 17, canCarry: false },
                // NPCs
                "MERMAID": { name: "MERMAID", description: "a Mermaid is gliding through the room maybe you can talk to her", location: 7, canCarry: false },
                "SHARK_TRIO": { name: "SHARK_TRIO", description: "three curious sharks circling you, eyeing you intently", location: 19, canCarry: false },
                "TURTLE_ELDER": { name: "TURTLE_ELDER", description: "an ancient turtle elder with a wise look", location: 18, canCarry: false },
                "PIRATE_GHOST": { name: "PIRATE_GHOST", description: "a ghostly pirate captain, shimmering faintly", location: 10, canCarry: false },
                "SEA_DRAGON": { name: "SEA_DRAGON", description: "a majestic sea dragon coils in the lair, its eyes glowing with wisdom", location: 20, canCarry: false },
                "COOK": { name: "COOK", description: "a cheerful ship's cook, busy with underwater ingredients", location: 4, canCarry: false }
            };

            // === UTILITY ===
            function setText(text) {
                document.getElementById('textArea').textContent = text;
            }

            function showIntroduction() {
                const intro = `=== UNDERWATER ADVENTURE ===

Your adventure starts by you getting on a train.
As you sit down you feel yourself starting to get sleepy.
Suddenly you fall into a deep sleep. When you wake up there is a harsh darkness surrounding you.
You figure that walking slowly to the door is the best option.
Once you open the door you are met with the soft sounds of water hitting the slick concrete floor.
The train leaves and you are now stranded in a cold and dark cavern.
There is an opening that you start walking through.
It's a dark and humid passage with water dripping from the ceiling.
Finally, you reach a drop off that leads into an underwater passage that is drawing you in.
Luckily you brought your scuba gear along.
Those marine biology classes finally paid off, as your professor always said:
-Take your scuba gear wherever you go and that's an order!-
You picture him yelling at you in the marine biology classroom.
You didn't particularly hate him, you knew he meant well.
You were just in the class to discover the wonders of mermaids.
Your biggest dream was to meet a mermaid in real life and hopefully become friends.
The drop off that leads into an underwater passage of your dreams is in front of you.
Thus you decide to jump right in and explore the area.

=== Click LOOK to begin your adventure! ===`;
                setText(intro);
            }

            function startMusic() {
                if (!musicPlaying) {
                    const music = document.getElementById('backgroundMusic');
                    music.volume = 0.3;
                    music.play().catch(e => {
                        console.log("Music autoplay blocked. Click the page to start music.");
                        // Show a message to the user
                        alert("Click OK to enable background music!");
                        music.play();
                    });
                    musicPlaying = true;
                }
            }

            function toggleMusic() {
                const music = document.getElementById('backgroundMusic');
                const button = document.getElementById('musicToggle');

                if (musicPlaying) {
                    music.pause();
                    musicPlaying = false;
                    button.textContent = 'üîá Music: OFF';
                } else {
                    music.play().catch(e => {
                        alert("Click OK to enable background music!");
                        music.play();
                    });
                    musicPlaying = true;
                    button.textContent = 'üîä Music: ON';
                }
            }

            function changeVolume(value) {
                const music = document.getElementById('backgroundMusic');
                music.volume = value / 100;
                document.getElementById('volumeDisplay').textContent = value + '%';
            }

            // === MAIN GAME ACTIONS ===

            // === QUEST TRACKER FUNCTIONS ===
            function showQuestTracker() {
                const questList = document.getElementById('questList');
                let questHTML = '';

                // Define all quests with their status
                const quests = [
                    {
                        name: "Mermaid's Crystal",
                        npc: "Mermaid",
                        location: "Mermaid Room",
                        itemNeeded: "CRYSTAL",
                        status: getQuestStatus(mermaidQuestStarted, mermaidQuestComplete, inventory.includes("CRYSTAL")),
                        description: "Bring a rare CRYSTAL from the Crystal Room to the Mermaid."
                    },
                    {
                        name: "Turtle Elder's Gem",
                        npc: "Turtle Elder",
                        location: "Turtle Palace",
                        itemNeeded: "GEM",
                        status: getQuestStatus(turtleQuestStarted, turtleQuestComplete, inventory.includes("GEM")),
                        description: "Return the precious GEM from the Gem Room to the Turtle Elder."
                    },
                    {
                        name: "Shark Trio's Plush",
                        npc: "Shark Trio",
                        location: "Shark Grove",
                        itemNeeded: "SHARKPLUSH",
                        status: getQuestStatus(sharkQuestStarted, sharkQuestComplete, inventory.includes("SHARKPLUSH")),
                        description: "Retrieve the SHARKPLUSH from the Storage Room for the Shark Trio."
                    },
                    {
                        name: "Pirate Ghost's Hat",
                        npc: "Pirate Ghost",
                        location: "Captain's Room",
                        itemNeeded: "HAT",
                        status: getQuestStatus(pirateQuestStarted, pirateQuestComplete, inventory.includes("HAT")),
                        description: "Find the captain's HAT in the Sunken Ship and return it to the Pirate Ghost."
                    },
                    {
                        name: "Sea Dragon's Egg",
                        npc: "Sea Dragon",
                        location: "Sea Dragon's Lair",
                        itemNeeded: "DRAGONEGG",
                        status: getQuestStatus(dragonQuestStarted, dragonQuestComplete, inventory.includes("DRAGONEGG")),
                        description: "Return the stolen DRAGONEGG from the Cellar to the Sea Dragon."
                    },
                    {
                        name: "Cook's Seaweed",
                        npc: "Cook",
                        location: "Underwater Restaurant",
                        itemNeeded: "SEAWEED",
                        status: getQuestStatus(cookQuestStarted, cookQuestComplete, inventory.includes("SEAWEED")),
                        description: "Fetch fresh SEAWEED from the Garden for the Cook's legendary stew."
                    },
                    {
                        name: "Designer's Silk",
                        npc: "Designer",
                        location: "Aquatic Clothing Shop",
                        itemNeeded: "SILK",
                        status: getQuestStatus(designerQuestStarted, designerQuestComplete, inventory.includes("SILK")),
                        description: "Obtain SILK from the Sea Dragon's mane for the Designer."
                    },
                    {
                        name: "King's Royal Clothes",
                        npc: "King",
                        location: "King's Room",
                        itemNeeded: "ROYAL_CLOTHES",
                        status: getQuestStatus(kingQuestStarted, kingQuestComplete, inventory.includes("ROYAL_CLOTHES")),
                        description: "Bring the ROYAL_CLOTHES from the Designer to the King."
                    },
                    {
                        name: "Gambler's Treasure",
                        npc: "Gambler",
                        location: "Underwater Casino",
                        itemNeeded: "CHEST",
                        status: getQuestStatus(gamblerQuestStarted, gamblerQuestComplete, inventory.includes("CHEST")),
                        description: "Retrieve the treasure CHEST from the Treasure Room for the Gambler."
                    },
                    {
                        name: "Crew Member's Telescope",
                        npc: "Crew Member",
                        location: "Deck",
                        itemNeeded: "TELESCOPE",
                        status: getQuestStatus(crewQuestStarted, crewQuestComplete, inventory.includes("TELESCOPE")),
                        description: "Get the TELESCOPE from the Crow's Nest for the Crew Member."
                    },
                    {
                        name: "Giant Squid's Peace",
                        npc: "Giant Squid",
                        location: "Sunken Ship",
                        itemNeeded: "SINGING_SHELL",
                        status: squidAsleep ? "‚úÖ COMPLETE" : (inventory.includes("SINGING_SHELL") ? "üü° ITEM ACQUIRED" : "üî¥ NOT STARTED"),
                        description: "Use the SINGING_SHELL to calm the distressed Giant Squid blocking the passage."
                    },
                    {
                        name: "Seal's Proposal Ring",
                        npc: "Seal",
                        location: "Underwater Lobby",
                        itemNeeded: "ANCIENT_PEARL",
                        status: getQuestStatus(sealQuestStarted, sealQuestComplete, inventory.includes("ANCIENT_PEARL")),
                        description: "Get the ANCIENT_PEARL from the Turtle Elder for the Seal's proposal."
                    },
                    {
                        name: "Tiko's Reunion",
                        npc: "Tiko & Turtle Elder",
                        location: "Cave Entrance ‚Üí Turtle Palace",
                        itemNeeded: "TIKO",
                        status: getQuestStatus(tikoQuestStarted, tikoQuestComplete, inventory.includes("TIKO")),
                        description: "Bring the lost hatchling Tiko to the Turtle Elder at the Turtle Palace."
                    }
                ];

                // Count completed quests
                const completed = quests.filter(q => q.status.includes("COMPLETE")).length;
                const total = quests.length;

                questHTML += `<div style="text-align: center; margin-bottom: 20px; padding: 10px; background: rgba(0, 50, 100, 0.9); border: 2px solid #00ccff; border-radius: 5px;">
    <h3 style="color: #00ff88; margin: 0;">Quests Completed: ${completed}/${total}</h3>
    <div style="height: 10px; background: #111; border-radius: 5px; margin-top: 8px; overflow: hidden;">
      <div style="width: ${(completed / total) * 100}%; background: linear-gradient(to right, #00ccff, #00ff88); height: 100%;"></div>
    </div>
  </div>`;

                // Display each quest
                quests.forEach(quest => {
                    let statusColor = "#ff4444"; // Red for not started
                    if (quest.status.includes("ACTIVE")) statusColor = "#ffaa00"; // Orange for active
                    if (quest.status.includes("ACQUIRED")) statusColor = "#ffff00"; // Yellow for item acquired
                    if (quest.status.includes("COMPLETE")) statusColor = "#00ff88"; // Green for complete

                    questHTML += `
      <div style="margin-bottom: 15px; padding: 10px; border-left: 4px solid ${statusColor}; background: rgba(0, 20, 40, 0.7); border-radius: 3px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
          <strong style="color: #00ccff; font-size: 16px;">${quest.name}</strong>
          <span style="background: ${statusColor}; color: #000; padding: 3px 10px; border-radius: 10px; font-weight: bold; font-size: 12px;">${quest.status}</span>
        </div>
        <div style="margin-left: 10px; margin-bottom: 5px;">
          <span style="color: #00aaee;">NPC:</span> ${quest.npc} | 
          <span style="color: #00aaee;">Location:</span> ${quest.location}
        </div>
        <div style="margin-left: 10px; margin-bottom: 5px; color: #aaa; font-size: 13px;">
          ${quest.description}
        </div>`;

                    if (quest.status.includes("ACTIVE") && !quest.status.includes("COMPLETE")) {
                        questHTML += `<div style="margin-left: 10px; color: #ffcc00; font-style: italic;">
        üìç Hint: ${quest.itemNeeded} can be found ${getItemLocation(quest.itemNeeded)}
      </div>`;
                    }

                    questHTML += `</div>`;
                });

                questList.innerHTML = questHTML;
                document.getElementById('questTrackerModal').style.display = 'block';
            }

            function closeQuestTrackerModal() {
                document.getElementById('questTrackerModal').style.display = 'none';
            }

            function getQuestStatus(started, completed, hasItem) {
                if (completed) return "‚úÖ COMPLETE";
                if (started && hasItem) return "üü° ITEM ACQUIRED";
                if (started) return "üü† ACTIVE";
                return "üî¥ NOT STARTED";
            }

            function getItemLocation(itemName) {
                const locations = {
                    "CRYSTAL": "in the Crystal Room",
                    "GEM": "in the Gem Room",
                    "SHARKPLUSH": "in the Storage Room",
                    "HAT": "somewhere in the Sunken Ship",
                    "DRAGONEGG": "hidden in the Cellar",
                    "SEAWEED": "growing in the Garden",
                    "SILK": "must be obtained from the Sea Dragon",
                    "ROYAL_CLOTHES": "being crafted by the Designer",
                    "CHEST": "in the Treasure Room",
                    "TELESCOPE": "in the Crow's Nest",
                    "SINGING_SHELL": "reward from the Mermaid after completing her quest",
                    "ANCIENT_PEARL": "reward from the Turtle Elder after reuniting Tiko",
                    "TIKO": "waiting at the Cave Entrance"
                };
                return locations[itemName] || "somewhere in the underwater realm";
            }


            function checkAllQuestsComplete() {
                if (mermaidQuestComplete && turtleQuestComplete && pirateQuestComplete &&
                    dragonQuestComplete && cookQuestComplete && sharkQuestComplete &&
                    designerQuestComplete && kingQuestComplete && gamblerQuestComplete && crewQuestComplete &&
                    sealQuestComplete && tikoQuestComplete &&
                    !allQuestsComplete) {
                    allQuestsComplete = true;
                    document.getElementById('returnHomeBtn').style.display = 'inline-block';
                    setText("\n‚ú® All quests complete! A warm feeling fills your heart. You can now choose to RETURN HOME. ‚ú®\n");
                }
            }

            // === GIVE ITEM LOGIC ===
            function giveItem() {
                // Only allow giving if in a quest NPC room
                let text = "\n=== GIVE ITEM ===\n";
                let npc = null;
                let questItem = null;
                let questStarted = false;
                let questComplete = false;
                let npcName = "";

                if (currentRoom === 7) { // Mermaid
                    npc = "mermaid";
                    questItem = "CRYSTAL";
                    questStarted = mermaidQuestStarted;
                    questComplete = mermaidQuestComplete;
                    npcName = "Mermaid";
                    // REPLACE the Turtle Elder section in giveItem() with this clearer logic:
                } else if (currentRoom === 18) {
                    // Handle Tiko reunion FIRST if player has Tiko
                    if (inventory.includes("TIKO") && !tikoQuestComplete) {
                        npc = "tiko_elder";
                        questItem = "TIKO";
                        questStarted = true; // Always available when carrying Tiko
                        questComplete = tikoQuestComplete;
                        npcName = "Turtle Elder (Tiko Reunion)";
                    }
                    // Otherwise handle gem quest
                    else if (inventory.includes("GEM") && !turtleQuestComplete) {
                        npc = "turtle";
                        questItem = "GEM";
                        questStarted = turtleQuestStarted;
                        questComplete = turtleQuestComplete;
                        npcName = "Turtle Elder (Gem Quest)";
                    }
                } else if (currentRoom === 3) { // Seal
                    npc = "seal";
                    questItem = "ANCIENT_PEARL";
                    questStarted = sealQuestStarted;
                    questComplete = sealQuestComplete;
                    npcName = "Seal";
                } else if (currentRoom === 9 && !squidAsleep) { // Giant Squid - only if still awake
                    npc = "squid";
                    questItem = "SINGING_SHELL";
                    questStarted = true; // Always available once you encounter it
                    questComplete = squidAsleep;
                    npcName = "Giant Squid";
                } else if (currentRoom === 19) { // Shark Trio
                    npc = "shark";
                    questItem = "SHARKPLUSH";
                    questStarted = sharkQuestStarted;
                    questComplete = sharkQuestComplete;
                    npcName = "Shark Trio";
                } else if (currentRoom === 10) { // Pirate Ghost
                    npc = "pirate";
                    questItem = "HAT";
                    questStarted = pirateQuestStarted;
                    questComplete = pirateQuestComplete;
                    npcName = "Pirate Ghost";
                } else if (currentRoom === 20) { // Sea Dragon
                    npc = "dragon";
                    questItem = "DRAGONEGG";
                    questStarted = dragonQuestStarted;
                    questComplete = dragonQuestComplete;
                    npcName = "Sea Dragon";
                } else if (currentRoom === 4) { // Cook
                    npc = "cook";
                    questItem = "SEAWEED";
                    questStarted = cookQuestStarted;
                    questComplete = cookQuestComplete;
                    npcName = "Cook";
                } else if (currentRoom === 0) { // Designer
                    npc = "designer";
                    questItem = "SILK";
                    questStarted = designerQuestStarted;
                    questComplete = designerQuestComplete;
                    npcName = "Designer";
                } else if (currentRoom === 17) { // King
                    npc = "king";
                    questItem = "ROYAL_CLOTHES";
                    questStarted = kingQuestStarted;
                    questComplete = kingQuestComplete;
                    npcName = "King";
                } else if (currentRoom === 1) { // Gambler
                    npc = "gambler";
                    questItem = "CHEST";
                    questStarted = gamblerQuestStarted;
                    questComplete = gamblerQuestComplete;
                    npcName = "Gambler";
                } else if (currentRoom === 12) { // Crew Member
                    npc = "crew";
                    questItem = "TELESCOPE";
                    questStarted = crewQuestStarted;
                    questComplete = crewQuestComplete;
                    npcName = "Crew Member";
                }



                if (!npc) {
                    text += "There is no one here to give an item to. Go to a quest NPC first.";
                    setText(text);
                    return;
                }
                if (!questStarted) {
                    text += `You need to take the quest from the ${npcName} first!`;
                    setText(text);
                    return;
                }
                if (questComplete) {
                    text += `You have already completed the ${npcName}'s quest.`;
                    setText(text);
                    return;
                }
                if (!inventory.includes(questItem)) {
                    text += `You do not have the required item (${questItem}) to give to the ${npcName}.`;
                    setText(text);
                    return;
                }

                // Remove item from inventory and complete quest
                inventory = inventory.filter(i => i !== questItem);

                if (npc === "mermaid") {
                    mermaidQuestComplete = true;
                    checkAllQuestsComplete();
                    // Give SINGING_SHELL as reward
                    if (!inventory.includes("SINGING_SHELL")) {
                        inventory.push("SINGING_SHELL");
                        text += "The Mermaid's eyes light up as you hand her the CRYSTAL. 'Thank you, friend! This is just what I needed for my collection. Please accept this SINGING SHELL as a token of my gratitude‚Äîit contains an ancient lullaby that can soothe even the most troubled souls.' You receive the SINGING SHELL! Quest complete!";
                    } else {
                        text += "The Mermaid's eyes light up as you hand her the CRYSTAL. 'Thank you, friend! This is just what I needed for my collection. Please accept my blessing as a token of my gratitude.' Quest complete!";
                    }
                } else if (npc === "tiko_elder") {
                    tikoQuestComplete = true;
                    checkAllQuestsComplete();
                    // Reunion scene
                    text += "You gently place Tiko down in front of the Turtle Elder.\n\n";
                    text += "Tiko: 'GRANDPA!' *eyes welling with tears*\n\n";
                    text += "Turtle Elder: 'TIKO?! My precious hatchling! You're here!' *eyes wide with surprise*\n\n";
                    text += "They embrace warmly, Tiko's tiny flippers barely reaching around the Elder's shell.\n\n";
                    text += "Turtle Elder: 'I lost complete track of time in meditation... I'm so sorry, little one!'\n\n";
                    text += "Tiko: 'It's okay Grandpa! This kind traveler brought me to you!'\n\n";
                    text += "The Turtle Elder turns to you with deep gratitude.\n\n";
                    text += "Turtle Elder: 'You reunited us. You're truly the hero of the reef!'\n\n";
                    if (!inventory.includes("ANCIENT_PEARL")) {
                        inventory.push("ANCIENT_PEARL");
                        text += "He reaches into his shell and pulls out an ANCIENT_PEARL. 'This has been in my family for generations. Only the bravest and kindest souls should possess it. Please, take it.' You receive the ANCIENT_PEARL! Quest complete!";
                    } else {
                        text += "He bows deeply in gratitude. Quest complete!";
                    }

                } else if (npc === "seal") {
                    sealQuestComplete = true;
                    checkAllQuestsComplete();
                    text += "The Seal's eyes light up as you hand over the glowing ANCIENT_PEARL! 'Oh, it's PERFECT! This pearl has been in the turtle family for generations!' Together you craft it into a beautiful ring. 'Thank you! I'm off to propose!' Quest complete!";

                } else if (npc === "squid") {
                    squidAsleep = true;
                    checkAllQuestsComplete();
                    text += "You hold up the SINGING SHELL and it begins to hum with a soothing, ancient lullaby.\n\n";
                    text += "The melody drifts through the water like silk...\n\n";
                    text += "Giant Squid: 'Hush now... that melody... my hatchlings used to sing...'\n\n";
                    text += "The squid's thrashing slows... its tentacles begin to uncoil from the mast...\n";
                    text += "Its eyes grow heavy... peaceful...\n\n";
                    text += "Giant Squid: *softly* '...sleepy now... finally... quiet...'\n\n";
                    text += "The massive squid slowly drifts down, curling into a peaceful ball on the ocean floor.\n";
                    text += "Soft snoring bubbles rise as it dreams of its hatchlings.\n";
                    text += "The passage is now clear! Quest complete!";

                } else if (npc === "turtle") {
                    turtleQuestComplete = true;
                    checkAllQuestsComplete();
                    text += "The Turtle Elder smiles slowly as you return the GEM. *He takes the gem with trembling flippers* 'This stone has witnessed a thousand tides with me... I feared I'd never feel its warmth again.' *eyes glisten* 'You have not just returned a treasure‚Äîyou've restored a piece of my soul. May the ocean's grace follow you always.' Quest complete!";

                } else if (npc === "designer") {
                    if (silkObtained) {
                        designerQuestComplete = true;
                        checkAllQuestsComplete();
                        // Give ROYAL_CLOTHES as reward
                        if (!inventory.includes("ROYAL_CLOTHES")) {
                            inventory.push("ROYAL_CLOTHES");
                            text += "The Designer's eyes light up as you hand over the shimmering SILK. 'Perfect! Absolutely perfect! This is exactly what I needed!' They work with incredible speed, their hands a blur of motion. Within moments, they present you with the finished garment. 'Here‚Äîthe ROYAL_CLOTHES, fit for a king! Take them to His Majesty at once!' You receive the ROYAL_CLOTHES! Quest complete!";
                        }
                    } else {
                        text += "Designer: 'This... this isn't dragon silk. I need the genuine article from the dragon's mane!'";
                    }

                } else if (npc === "king") {
                    kingQuestComplete = true;
                    satOnThroneBeforeKingQuest = false; // Forgive the transgression
                    checkAllQuestsComplete();
                    text += "The King takes the ROYAL_CLOTHES and immediately puts them on. He admires himself regally. 'Finally! Perfection! These garments are worthy of my station.' He turns to you with a smile. ";
                    if (satOnThroneBeforeKingQuest) {
                        text += "'And I forgive you for sitting on my throne. You have redeemed yourself through service.' ";
                    }
                    text += "Quest complete!";

                } else if (npc === "gambler") {
                    gamblerQuestComplete = true;
                    checkAllQuestsComplete();
                    text += "The Gambler's hands tremble as you hand over the treasure CHEST. 'This is it! My last chance!' He rushes to the roulette wheel and places the entire treasure on red. The wheel spins... and spins... and... 'RED! I WON! I ACTUALLY WON!' Tears stream down his face. 'After all these years... thank you. Thank you so much. I'm free!' Quest complete!";

                } else if (npc === "crew") {
                    crewQuestComplete = true;
                    checkAllQuestsComplete();
                    // Give HAT as reward
                    if (!inventory.includes("HAT")) {
                        inventory.push("HAT");
                        text += "The Crew Member takes the TELESCOPE with shaking hands. They look up through it toward the surface, and you see tears in their eyes. 'The stars... Orion's Belt... the North Star... they're all still there.' They lower the telescope and turn to you with a grateful smile. 'I can rest now. Here‚Äîtake the captain's HAT. He would want someone worthy to have it. You've given me peace, friend.' You receive the captain's HAT! Quest complete!";
                    } else {
                        text += "The Crew Member takes the TELESCOPE with shaking hands. They look up through it toward the surface, and you see tears in their eyes. 'The stars... Orion's Belt... the North Star... they're all still there.' They lower the telescope and smile at you. 'I can rest now. Thank you, friend. You've given me peace.' Quest complete!";
                    }

                } else if (npc === "shark") {
                    if (sharkPlushUsed) {
                        text += "Doug takes the plush and examines it closely. His eyes well up with tears.\nDoug: 'It's... it's TORN! You USED our precious plush and DAMAGED it!'\nSmug: 'That's messed up, dude. Really messed up.'\nShrug: 'We'll remember this.'\nDoug sniffles: 'Just... just go.' He looks heartbroken.\n\nQuest complete... but at what cost?";
                    } else {
                        text += "Doug takes the SHARKPLUSH and hugs it close, tears streaming down his face.\nDoug: 'You brought it back! Safe and sound! Thank you so much!'\nSmug wipes his eye: 'Yeah... thanks. You're pretty cool.'\nShrug: 'This means a lot.'\n\nQuest complete!";
                    }
                    sharkQuestComplete = true;
                    checkAllQuestsComplete();

                } else if (npc === "pirate") {
                    pirateQuestComplete = true;
                    pirateGhostMad = false;
                    checkAllQuestsComplete();
                    // Give the player the ghost key
                    if (!inventory.includes("GHOST_KEY")) {
                        inventory.push("GHOST_KEY");
                        text += "*voice trembling* 'Me hat... after all these years...' *ghostly form shimmers with emotion* 'I wore this the day me ship went down. Thank ye, matey. For the first time since I died... I feel whole again. As promised, take this ghostly key‚Äîit'll open the cellar for ye. May fortune and fair winds follow ye always.' You receive the GHOST_KEY! Quest complete!";
                    } else {
                        text += "*voice trembling* 'Me hat... after all these years...' *ghostly form shimmers with emotion* 'I wore this the day me ship went down. Thank ye, matey. For the first time since I died... I feel whole again.' Quest complete!";
                    }

                } else if (npc === "dragon") {
                    dragonQuestComplete = true;
                    checkAllQuestsComplete();
                    // Give SILK as reward
                    if (!inventory.includes("SILK")) {
                        inventory.push("SILK");
                        silkObtained = true;
                        text += "The Sea Dragon coils around the DRAGONEGG protectively. 'You have done a great deed, brave one. My thanks‚Äîand may the ocean's power be with you.' The dragon reaches up and plucks a strand of shimmering silk from its mane. 'Take this SILK. Few have earned such a gift. The designer seeks this, I believe.' You receive dragon SILK! Quest complete!";
                    } else {
                        text += "The Sea Dragon coils around the DRAGONEGG protectively. 'You have done a great deed, brave one. My thanks‚Äîand may the ocean's power be with you.' Quest complete!";
                    }

                } else if (npc === "cook") {
                    // Check if seaweed was used/eaten
                    if (seaweedUsed) {
                        cookGivenUsedSeaweed = true; // REMEMBER THIS BETRAYAL
                        // Remove the used seaweed from inventory (already removed above)
                        // Reset the flag so player can get fresh seaweed
                        seaweedUsed = false;
                        // Make seaweed appear back in the garden
                        items["SEAWEED"].location = 8;
                        text += "The Cook takes one look at the seaweed and recoils in disgust! 'BLECH! This seaweed is all chewed up and soggy! Did you use this as a SNACK?! How DARE you bring me your half-eaten leftovers! I need FRESH seaweed from the garden, not your underwater garbage! Get out of my kitchen and bring me a proper, untouched seaweed!'";
                    } else {
                        cookQuestComplete = true;
                        checkAllQuestsComplete();
                        // Give the player the KEY as a reward
                        if (!inventory.includes("KEY")) {
                            inventory.push("KEY");
                            text += "The Cook claps his fins in delight as you give him the SEAWEED. 'Marvelous! This will make my stew legendary. Thank you, friend! Here, take this old KEY to the storage room I found in the galley. It might come in handy for ye!' You receive the KEY! Quest complete!";
                        } else {
                            text += "The Cook claps his fins in delight as you give him the SEAWEED. 'Marvelous! This will make my stew legendary. Thank you, friend! Come back anytime for a meal.' Quest complete!";
                        }
                    }
                }

                setText(text);
            }
            function lookAround() {
                gameStarted = true;
                startMusic();
                let text = "\n=== LOOK AROUND ===\n";
                text += `I am in a ${roomDescriptions[currentRoom]}.\n\n`;
                const directions = ["NORTH", "SOUTH", "EAST", "WEST"];
                for (let i = 0; i < 4; i++) {
                    if (roomConnections[currentRoom][i] !== -1) {
                        const nextRoom = roomConnections[currentRoom][i];
                        text += `There is an exit ${directions[i]} to a ${roomDescriptions[nextRoom]}.\n`;
                    }
                }
                text += "\n";
                for (let itemKey in items) {
                    const item = items[itemKey];
                    if (item.location === currentRoom) {
                        text += `I see ${item.description}.\n`;
                    }
                }
                setText(text);
            }

            function examine() {
                let text = "\n=== EXAMINE ===\n";

                const examines = {
                    0: "Bolts of shimmering fabric drift like underwater kelp forests. The Designer hums softly while stitching royal silk, their fingers moving with practiced grace. Life jackets bob gently like sleeping jellyfish‚Äîa quiet promise of safety in these deep waters.",
                    1: "The ghostly roulette wheel spins endlessly in the current, its numbers blurred by time. Shriveled banknotes drift like ghostly jellyfish‚Äîremnants of fortunes lost to the depths. The Gambler's hollow eyes follow you, haunted by Lady Luck's abandonment.",
                    2: "A sunken parking meter stands sentinel here, its coin slot choked with sand and regret. The current tugs insistently‚Äîa warning to those who linger too long. Nearby, you hear faint, hopeful sniffles: Tiko clutching his seaweed map, waiting for someone brave enough to help him find Grandpa.",
                    3: "A magnet floats near the ceiling, gently pulling at metal fragments in the water. It hums with a soft energy, as if remembering the ships it once guided. The Seal paces nervously nearby, adjusting his kelp bowtie for the hundredth time, muttering about proposal rings and true love.",
                    4: "Copper pots bubble with mysterious stews. Dried seaweed hangs from lines like forgotten memories. The Cook moves with practiced grace, his ladle a conductor's baton for underwater symphonies. 'A pinch of sea salt makes every dish better,' he murmurs without looking up.",
                    5: "The narrow hallway echoes with distant water sounds. Faded murals on the walls tell silent stories of ancient sea voyages‚Äîships that sailed these waters long before they became your path. The water here holds memories of those who passed before you.",
                    6: "Crates and barrels form a labyrinth of forgotten cargo. Dust motes drift like forgotten memories in the gentle current. In one corner, a small, well-loved SHARKPLUSH peeks out from behind a barrel‚Äîwaiting for its owners to find the courage to retrieve it.",
                    7: "Pearls glow softly along the walls, casting shifting light patterns that dance like living memories. The water here feels thicker, heavier with ancient magic. The Mermaid glides through the chamber, her eyes meeting yours with wisdom earned over centuries. She seems to want something from you...",
                    8: "Kelp forests sway in hypnotic rhythm. Bioluminescent anemones pulse gently, their light revealing hidden paths. Among the fronds, fresh SEAWEED grows in vibrant emerald clusters‚Äîa gift from the ocean itself. The peaceful surroundings calm your racing thoughts, if only for a moment.",
                    9: "The sunken ship groans with every current‚Äîa mournful song of lost voyages. Its mast is wrapped tight by the Giant Squid's tentacles‚Äîa living prison of grief and memory. Ink clouds swirl where trauma lives. The squid thrashes in anguish, its cries echoing: 'My hatchlings... where are my hatchlings?!'",
                    10: "A captain's desk remains perfectly preserved, quill still in inkwell as if waiting for its owner's return. A single bicorn hat rests on the chair‚Äîempty, but not abandoned. The Pirate Ghost floats nearby, his spectral form shimmering with lost purpose. His eyes glow with the fire of a captain who refuses to surrender his ship.",
                    11: "The crow's nest offers a view upward through fathoms of water. Faint starlight filters down‚Äîa ghost of the surface world this crew can never reach again. The old TELESCOPE sits waiting, its lenses clouded with longing. Somewhere below, a crew member dreams of constellations he'll never see again.",
                    12: "Weathered rope coils like sleeping sea serpents. The deck planks bear the scars of storms weathered and battles fought. A single telescope lies where it was dropped in the final moments. The Crew Member gazes upward, forever searching for stars hidden by the surface. His longing hangs heavy in the water here.",
                    13: "Bones rest in quiet repose‚Äînot frightening, but peaceful. They tell a story not of terror, but of rest after a long journey. In their stillness, you find unexpected comfort. The DRAGONEGG glows softly in one corner, pulsing with life‚Äîa secret the Sea Dragon desperately seeks. This is where a mother's heart was broken.",
                    14: "Gems aren't just sparkling‚Äîthey breathe light. Each facet catches the current and throws rainbows that paint the walls with fleeting beauty. It's hypnotic, almost alive. The Turtle Elder's missing treasure calls to you from these glittering depths, waiting for a worthy hand to return it home.",
                    15: "The treasure chest isn't overflowing with gold‚Äîit's modest, humble. As if the real treasure was never the coins, but the hope they represented to those who sought them. The Gambler's desperation lingers here‚Äîa reminder that not all treasure brings happiness.",
                    16: "Crystals don't just shine‚Äîthey sing. A faint harmonic hum vibrates through the water, a song older than the ocean itself. This is where light goes to dream. The Mermaid's collection awaits here, each crystal holding a captured star. She needs one for her collection‚Äîa gift of light from the depths.",
                    17: "The throne isn't just carved stone‚Äîit's woven from coral and whalebone, grown over centuries. It pulses with a slow, regal heartbeat. To sit here is to feel the weight of kingdoms. The King watches from nearby, his expression displeased. His royal clothes are incomplete, and his patience wears thin.",
                    18: "The palace isn't built‚Äîit's grown. Living coral forms archways where generations of turtles have passed. The water here moves with the patience of deep time. The Turtle Elder watches over his kin, his ancient eyes holding the weight of generations. Somewhere, he wonders if his lost hatchling is safe...",
                    19: "Shark teeth marks scar the rocks‚Äînot from violence, but from play. A small carving of a shark wearing a crown is scratched near the entrance‚ÄîDoug's secret masterpiece. The Shark Trio circles at a respectful distance, their eyes watchful but not hostile. Doug glances toward the storage room, his gaze lingering on the path to his lost SHARKPLUSH.",
                    20: "The dragon's lair smells of ozone and ancient power. Scales shed over millennia form a mosaic on the floor‚Äîa history written in iridescence. The air thrums with protective energy. The Sea Dragon coils majestically, its eyes glowing with wisdom older than empires. It seems to want something from you‚Äîa debt to be repaid, a wrong to be righted."
                };

                text += examines[currentRoom] || "You sense the history in these waters‚Äîa story waiting to be heard by those who listen closely.";
                setText(text);
            }

            function returnHome() {
                if (!allQuestsComplete) {
                    setText("\nYou're not ready to leave yet. Complete all your friendships first.");
                    return;
                }

                let text = "\n" + "=".repeat(50) + "\n";
                text += "üåä CHOOSE YOUR BEST FRIEND üåä\n";
                text += "=".repeat(50) + "\n\n";
                text += "The time has come to return to the mainland.\n";
                text += "Choose the companion who became your dearest friend,\n";
                text += "the one who will guide you back to your world:\n\n";

                setText(text);

                // Hide normal action buttons
                document.querySelectorAll('.action-panel button, .movement-panel button').forEach(btn => {
                    btn.style.display = 'none';
                });

                // Show companion selection buttons
                const actionPanel = document.querySelector('.action-panel');
                actionPanel.innerHTML = `
    <button onclick="handleCompanionChoice('mermaid')" style="grid-column: span 1;">üßú‚Äç‚ôÄÔ∏è MERMAID</button>
    <button onclick="handleCompanionChoice('turtle')" style="grid-column: span 1;">üê¢ TURTLE ELDER</button>
    <button onclick="handleCompanionChoice('pirate')" style="grid-column: span 1;">‚ò†Ô∏è PIRATE GHOST</button>
    <button onclick="handleCompanionChoice('dragon')" style="grid-column: span 1;">üêâ SEA DRAGON</button>
    <button onclick="handleCompanionChoice('cook')" style="grid-column: span 1;">üç≤ COOK</button>
    <button onclick="handleCompanionChoice('sharks')" style="grid-column: span 1;">ü¶à SHARK TRIO</button>
    <button onclick="handleCompanionChoice('designer')" style="grid-column: span 1;">üëî DESIGNER</button>
    <button onclick="handleCompanionChoice('king')" style="grid-column: span 1;">üëë KING</button>
    <button onclick="handleCompanionChoice('gambler')" style="grid-column: span 1;">üé∞ GAMBLER</button>
    <button onclick="handleCompanionChoice('crew')" style="grid-column: span 1;">‚≠ê CREW</button>
    <button onclick="handleCompanionChoice('squid')" style="grid-column: span 1;">ü¶ë SQUID</button>
    <button onclick="handleCompanionChoice('seal')" style="grid-column: span 1;">ü¶≠ SEAL</button>
    <button onclick="handleCompanionChoice('tiko')" style="grid-column: span 1;">üê¢ TIKO & ELDER</button>
`;
            }

            function showInventory() {
                let text = "\n=== INVENTORY ===\n";
                if (inventory.length === 0) {
                    text += "Your inventory is empty.";
                } else {
                    text += "You are carrying:\n";
                    inventory.forEach(item => {
                        text += `- ${item}\n`;
                    });
                }
                setText(text);
            }

            function getItem() {
                // üîí PREVENT PICKING UP TIKO BEFORE QUEST STARTED
                if (currentRoom === 2 && !tikoQuestStarted && items["TIKO"].location === 2) {
                    setText(`
=== GET ITEM ===
Tiko looks up at you with big, teary eyes and shakes his head.
'I can't go with you yet... I need to know you'll help me find Grandpa.
Please TALK to me first so I know I can trust you!' (Take Quest from Tiko)
`);
                    return;
                }
                // Prevent duplicate items in inventory
                let text = "\n=== GET ITEM ===\n";
                let found = false;
                for (let itemKey in items) {
                    const item = items[itemKey];
                    // Allow picking up any item that can be carried
                    if (item.location === currentRoom && item.canCarry) {
                        if (!inventory.includes(item.name)) {
                            inventory.push(item.name);
                            item.location = -1;
                            // Reset seaweedUsed flag when picking up fresh seaweed
                            if (item.name === "SEAWEED") {
                                seaweedUsed = false;
                            }
                            text += `The item ${item.name} was placed in your inventory.`;
                        } else {
                            text += `You already have the ${item.name}.`;
                        }
                        found = true;
                        break;
                    }
                }
                if (!found) {
                    text += "There is no item to get here.";
                }
                setText(text);
            }

            function rest() {
                let text = "\n=== REST ===\n";
                const restMessages = {
                    0: "You drift among floating garments in the Aquatic Clothing Shop. The Designer hums softly while stitching royal silk, their fingers moving with practiced grace. For a moment, the weight of your quest feels lighter here.",
                    1: "You rest near the ghostly roulette wheel. Seaweed sways hypnotically around shriveled banknotes‚Äîremnants of fortunes lost to the depths. The Gambler's hollow eyes follow you, haunted by Lady Luck's abandonment.",
                    2: "The current tugs insistently at your limbs. This cave entrance offers no peace‚Äîonly the pull of deeper waters and the faint, hopeful sniffles of Tiko waiting nearby, clutching his seaweed map tightly.",
                    3: "You rest in the underwater hotel lobby. Sunbeams filter through the surface far above, casting dancing light patterns on the floor. The Seal paces nervously nearby, adjusting his kelp bowtie for the hundredth time.",
                    4: "You take refuge in the restaurant's quiet corner. The Cook's bubbling pots fill the water with savory aromas, and for a moment, the loneliness of the deep feels a little less heavy. 'Rest well, traveler,' he murmurs without looking up from his stew.",
                    5: "You rest in the narrow corridor. Faded murals on the walls tell silent stories of ancient sea voyages‚Äîships that sailed these waters long before they became your path. The water here holds memories of those who passed before you.",
                    6: "You find solitude among stored treasures in the quiet storeroom. Dust motes drift like forgotten memories in the gentle current. Somewhere in the shadows, the SHARKPLUSH waits‚Äîabandoned but not forgotten.",
                    7: "You rest in the Mermaid's chamber. Pearls glow with soft luminescence, and the water itself seems to hum with ancient magic‚Äîa sanctuary where dreams feel closer than reality. The Mermaid watches you with eyes that have seen centuries flow like tides.",
                    8: "You rest in the tranquil garden. Bioluminescent anemones pulse gently like slow heartbeats, and kelp forests sway in a hypnotic rhythm that quiets your racing thoughts. Fresh SEAWEED brushes against your arm‚Äîa gift from the ocean itself.",
                    9: "You rest against the sunken ship's hull. The wood groans with each current‚Äîa mournful song of lost voyages. Nearby, the Giant Squid thrashes in anguish, its tentacles coiled tight around the mast as traumatic memories echo through the metal tomb.",
                    10: "You rest in the captain's quarters. A cold shiver traces your spine as phantom echoes of laughter and storm warnings drift through the water‚Äîthe Pirate Ghost's memories brushing against your own. His spectral form flickers in the corner, watching silently.",
                    11: "You rest at the crow's nest's highest point. Though submerged, you imagine starlight filtering down through fathoms of water‚Äîa ghost of navigation, of paths once charted toward home. The Crew Member's longing for the stars hangs heavy in the water here.",
                    12: "You rest on the ship's weathered deck. Barnacles cling like stubborn memories, and the wood‚Äîthough waterlogged‚Äîstill holds the dignity of vessels that once ruled the waves. The Crew Member gazes upward, forever searching for constellations hidden by the surface.",
                    13: "You rest in the dark cellar. Bones rest peacefully nearby, not as horrors but as quiet witnesses to lives fully lived. In their stillness, you find unexpected comfort. The DRAGONEGG glows softly in one corner, pulsing with life‚Äîa secret the Sea Dragon desperately seeks.",
                    14: "You rest surrounded by gems that breathe light. Their inner fire pulses softly, as if each stone holds a captured star‚Äîreminding you that even in darkness, beauty persists. The Turtle Elder's missing treasure calls to you from these glittering depths.",
                    15: "You rest beside the treasure chest. Gold coins gleam with cold fire, but their shine feels hollow compared to the warmth of friendships forged in these depths. The Gambler's desperation lingers here‚Äîa reminder that not all treasure brings happiness.",
                    16: "You rest among singing crystals. Their harmonic hum vibrates through the water‚Äîa song older than empires, older than memory, that soothes something deep within your soul. This is where light goes to dream.",
                    17: "You rest near the throne, feeling its ancient power thrum through the water. This is not a place for rest‚Äîbut for a moment, you understand why kings would fight to claim it. The King's absence feels like a held breath, waiting for his royal garments to return.",
                    18: "You rest with the sea turtles in their palace. Their slow, rhythmic movements speak of patience earned through centuries‚Äîthe wisdom that some journeys cannot be rushed. The Turtle Elder watches over his kin, his ancient eyes holding the weight of generations. Somewhere, he wonders if his lost hatchling is safe...",
                    19: "You rest at the edge of the shark grove, heart pounding. The sharks circle at a respectful distance, their eyes watchful but not hostile‚Äîa tense truce in waters that respect strength. Doug glances toward the storage room, his gaze lingering on the path to his lost SHARKPLUSH.",
                    20: "You dare to rest near the dragon's lair. Heat radiates from the empty nesting spot where the DRAGONEGG once lay, and the Sea Dragon's watchful gaze holds not threat, but ancient guardianship‚Äîa reminder that some treasures are worth protecting with fire and scale."
                };
                text += restMessages[currentRoom] || "You take a moment to rest and catch your breath in these mysterious waters, feeling the ocean's pulse slow to match your own.";
                setText(text);
            }

            function useItem() {
                if (inventory.length === 0) {
                    setText("\n=== USE ITEM ===\nYou have nothing in your inventory, go find some items to use.");
                    return;
                }
                const modal = document.getElementById('useItemModal');
                const itemList = document.getElementById('itemList');
                itemList.innerHTML = '';
                inventory.forEach((item) => {
                    const btn = document.createElement('button');
                    btn.className = 'item-button';
                    btn.type = 'button';
                    btn.setAttribute('aria-label', `Use ${item}`);
                    btn.setAttribute('tabindex', '0');
                    btn.textContent = item;
                    btn.onclick = () => useSelectedItem(item);
                    itemList.appendChild(btn);
                });
                modal.style.display = 'block';
            }

            function useSelectedItem(item) {
                closeModal();
                let text = `\n=== USE ITEM ===\nYou used the ${item}.\n`;
                const useMessages = {
                    "KEY": "You need to be at a door to use the key. Try OPEN or CLOSE at the corridor.",
                    "GHOST_KEY": "The ghostly key shimmers in your hand. It feels cold and ethereal, ready to unlock a spectral door.",
                    "MAGNET": "The magnet pulls at nearby metal objects. It tingles in your hand.",
                    "MONEY": "The money is too shriveled and waterlogged to spend anywhere.",
                    "GEM": "The gem sparkles beautifully in your hand. It's quite valuable!",
                    "CRYSTAL": "The crystal glows with an inner light. Its beauty is captivating.",
                    "DRAGONEGG": "You hold the dragon egg carefully. It's warm to the touch. You hope the mother doesn't find out!",
                    "TELESCOPE": "You look through the old telescope and see distant underwater landscapes and mysterious creatures.",
                    "HAT": "You put on the captain's hat. You feel like a true pirate! Arr matey!",
                    "SEAWEED": (() => {
                        seaweedUsed = true;
                        return "You nibble on the seaweed. It's not very tasty, but it fills your belly. The seaweed is now used and soggy.";
                    })(),
                    "ROPE": "You test the rope's strength. It could be useful for climbing or tying things.",
                    "CHEST": "You try to open the chest, but it's locked tight. Maybe there's a key somewhere.",
                    "LIFEJACKET": "You put on the lifejacket. It feels odd to wear underwater, but you feel a bit safer.",
                    "BONES": "You examine the bones. They send a chill down your spine.",
                    "THRONE": "You sit on the throne for a moment, feeling regal.",
                    "MERMAID": "The mermaid smiles at you. She seems pleased to see you using your items.",
                    "TURTLE_ELDER": "The Turtle Elder nods wisely as you show him your item.",
                    "PIRATE_GHOST": "The Pirate Ghost grins, his eyes gleaming with approval.",
                    "SEA_DRAGON": "The Sea Dragon watches you intently, its gaze full of ancient wisdom.",
                    "COOK": "The Cook sniffs your item, wondering if it could be used in a new recipe."
                };

                if (item === "HAT" && !pirateQuestComplete) {
                    pirateGhostMad = true;
                    text += "\nAs you put on the hat, you feel a chill in the air... Did someone see you? The Pirate Ghost looks angry that you took his hat without permission! ";
                }

                if (item === "SHARKPLUSH") {
                    sharkPlushUsed = true;
                    text += "You hug the soft SHARKPLUSH tightly. It's so comforting and warm...\n*RIIIP*\nOh no! A small tear appears in the fabric! You've damaged it!";
                } else {
                    text += useMessages[item] || "Nothing special happens when you use this item.";
                }

                setText(text);
            }

            function closeModal() {
                document.getElementById('useItemModal').style.display = 'none';
            }

            function openDoor() {
                let text = "\n=== OPEN ===\n";

                if (currentRoom === 5 || currentRoom === 6) {
                    if (inventory.includes("KEY")) {
                        doorOpen = true;
                        text += "You use the rusty key to unlock the door. The door is now open.";
                    } else {
                        text += "The door is locked. You need a key to open it.";
                    }
                } else if (currentRoom === 13 || currentRoom === 12) {
                    if (inventory.includes("GHOST_KEY")) {
                        cellarOpen = true;
                        text += "You use the ghostly key to unlock the cellar door. The spectral lock fades away.";
                    } else {
                        text += "The cellar door is locked. You need a ghostly key to open it.";
                    }
                } else {
                    text += "Opening that is not possible.";
                }

                setText(text);
            }

            function closeDoor() {
                let text = "\n=== CLOSE ===\n";

                if (currentRoom === 5 || currentRoom === 6) {
                    if (inventory.includes("KEY")) {
                        doorOpen = false;
                        text += "You use the key to lock the door. The door is now closed.";
                    } else {
                        text += "You need the key to lock the door.";
                    }
                } else if (currentRoom === 13 || currentRoom === 12) {
                    if (inventory.includes("GHOST_KEY")) {
                        cellarOpen = false;
                        text += "You use the ghostly key to lock the cellar door. The spectral lock returns.";
                    } else {
                        text += "You need the ghostly key to lock the cellar door.";
                    }
                } else {
                    text += "Closing that is not possible.";
                }

                setText(text);
            }

            function sitStand() {
                let text = "\n=== SIT/STAND ===\n";

                if (isSitting) {
                    isSitting = false;
                    text += "You stand up and are ready to move again.";
                } else if (currentRoom === 17) {
                    isSitting = true;
                    if (!kingQuestStarted) {
                        satOnThroneBeforeKingQuest = true; // Track this!
                    }
                    text += "You sit on the throne. The ancient power fills you with passion!\n";
                    if (!kingQuestComplete && satOnThroneBeforeKingQuest) {
                        text += "You hear an angry voice: 'WHO DARES SIT UPON MY THRONE?!' The king does not look pleased...\n";
                    }
                    text += "Press SIT/STAND again to get up.";
                } else {
                    text += "There is no place to sit here.";
                }

                setText(text);
            }

            function talk() {
                let text = "\n=== TALK ===\n";
                // Mermaid (room 7)
                if (currentRoom === 7) {
                    const mermaidLore = [
                        "Mermaid: '*voice like rippling water* 'Your heart called to these depths, traveler. You got your style, now let it shine through, and remember no matter what, you got to be you.'",
                        "Mermaid: 'You seem brave to venture so deep underwater. Are you searching for something special?'",
                        "Mermaid: 'I've lived in these waters for centuries. I've seen many treasures and dangers alike.'",
                        "Mermaid: 'Beware the shark grove to the east. Many adventurers have not returned from there.'",
                        "Mermaid: 'The King's Room holds ancient power. Sit upon the throne if you dare!'",
                        "Mermaid: 'I hear a sea dragon guards something precious in the southern waters. Would you be brave enough to face it?'",
                        "Mermaid: 'The sunken ship to the north holds secrets from the pirate age. The captain was quite fearsome!'",
                        "Mermaid: 'Have you found the key yet? It unlocks many mysteries in this underwater realm.'",
                        "Mermaid: 'The turtles in their palace are gentle creatures. They've seen much in their long lives.'",
                        "Mermaid: 'You remind me of the old marine biology students who used to explore these waters.'",
                        "Mermaid: 'You're quite persistent! I like that about you. Perhaps we can be friends after all.'"
                    ];
                    text += mermaidLore[(mermaidDialogueCount % mermaidLore.length)] + "\n";
                    mermaidDialogueCount++;

                    // Shark Trio (room 19)
                } else if (currentRoom === 19) {
                    const sharkLore = [
                        "Doug (sadly): 'We're not just tough guys... we have feelings too, ya know.'\nSmug: 'Yeah, obviously. We're the most emotional gang in the ocean.'\nShrug: 'Whatever.'",
                        "Smug: 'We rule this grove. Nobody messes with us.'\nDoug: 'Well... except when we lost our plush...'\nShrug: 'Eh.'",
                        "Shrug: 'I don't really care about much.'\nDoug: 'That's not true! You cried when we lost the plush!'\nShrug: '...Maybe a little.'",
                        "Doug: 'The storage room is scary... that's why we couldn't get our plush back.'\nSmug: 'We're NOT scared! We just... had other priorities!'\nShrug: 'Sure.'",
                        "Smug: 'The mermaid thinks she's so cool with her singing.'\nDoug: 'I think her voice is pretty...'\nSmug: 'DOUG! We have a reputation!'",
                        "Doug: 'The turtle elder is so wise. I wish he'd give us advice.'\nShrug: 'He probably would. If we asked.'\nSmug: 'We don't NEED advice!'",
                        "Shrug: 'The pirate ghost is alright I guess.'\nDoug: 'He told us a scary story once and I couldn't sleep!'\nSmug: 'Doug! Stop making us look soft!'",
                        "Smug: 'The sea dragon respects strength. He probably respects us.'\nDoug: 'Do you think he'd be our friend?'\nShrug: 'Doubt it.'",
                        "Doug: 'The cook makes the best food... it reminds me of home.'\nSmug: 'Home?! We're TOUGH SHARKS, we don't get homesick!'\nShrug: 'I get homesick.'",
                        "Shrug: 'This grove is fine.'\nSmug: 'FINE?! It's the BEST spot in the ocean!'\nDoug: 'It would be perfect if we had our plush back...'",
                        "Doug: 'Thanks for being our friend.'\nSmug: 'Not that we NEED friends or anything!'\nShrug: 'We do though.'"
                    ];
                    text += sharkLore[(sharkDialogueCount % sharkLore.length)] + "\n";
                    sharkDialogueCount++;

                    // Turtle Elder (room 18)
                } else if (currentRoom === 18) {
                    const turtleLore = [
                        "Turtle Elder: 'Welcome, young one. The tides have brought you far.'",
                        "Turtle Elder: 'Patience is the greatest wisdom. Even the slowest can reach their destination.'",
                        "Turtle Elder: 'The palace has stood for centuries, sheltering many generations.'",
                        "Turtle Elder: 'The garden is a place of peace. Many secrets are hidden among the plants.'",
                        "Turtle Elder: 'Beware the shark grove. Even turtles avoid it.'",
                        "Turtle Elder: 'The king's throne is not for everyone. Only the worthy may sit.'",
                        "Turtle Elder: 'Legends say the sea dragon once visited our palace.'",
                        "Turtle Elder: 'The merfolk are wise and kind. Have you met the mermaid?'",
                        "Turtle Elder: 'A true friend is a treasure greater than any gem.'",
                        "Turtle Elder: 'You remind me of a young turtle who dreamed of adventure.'",
                        "Turtle Elder: 'Return often, traveler. The palace doors are always open to you.'"
                    ];
                    text += turtleLore[(turtleDialogueCount % turtleLore.length)] + "\n";
                    turtleDialogueCount++;
                    // Pirate Ghost (room 10)
                } else if (currentRoom === 10) {
                    if (pirateGhostMad) {
                        text += "Pirate Ghost: 'I saw ye wearin' me hat! That hat be precious to me. Return it, and maybe I'll forgive ye.'\n";
                    } else {
                        const pirateLore = [
                            "Pirate Ghost: 'Arrr! The sea be full of mysteries and lost souls.'",
                            "Pirate Ghost: 'I once sailed these waters with a fearless crew.'",
                            "Pirate Ghost: 'Beware the cursed treasure. Not all gold brings happiness.'",
                            "Pirate Ghost: 'The captain's hat is a symbol of honor. Treat it well.'",
                            "Pirate Ghost: 'The deck hides secrets for those who look closely.'",
                            "Pirate Ghost: 'The mermaid knows more than she lets on.'",
                            "Pirate Ghost: 'I miss the taste of rum and the thrill of a storm.'",
                            "Pirate Ghost: 'The king's room was once the site of a great battle.'",
                            "Pirate Ghost: 'Even in death, I guard my ship.'",
                            "Pirate Ghost: 'The sea dragon and I were rivals in another life.'",
                            "Pirate Ghost: 'You have the spirit of a true adventurer.'"
                        ];
                        text += pirateLore[(pirateDialogueCount % pirateLore.length)] + "\n";
                        pirateDialogueCount++;
                    }
                    // Sea Dragon (room 20)
                } else if (currentRoom === 20) {
                    const dragonLore = [
                        "Sea Dragon: 'The deep currents whisper secrets to those who listen.'",
                        "Sea Dragon: 'I have seen empires rise and fall beneath the waves.'",
                        "Sea Dragon: 'My lair is a place of power and solitude.'",
                        "Sea Dragon: 'The gem room sparkles, but true treasure is wisdom.'",
                        "Sea Dragon: 'Beware the sharks. Even dragons respect their hunger.'",
                        "Sea Dragon: 'The mermaid once sang a song that calmed the storms.'",
                        "Sea Dragon: 'The turtle elder is older than even I.'",
                        "Sea Dragon: 'Legends say a king once rode a dragon into battle.'",
                        "Sea Dragon: 'The pirate ghost and I have unfinished business.'",
                        "Sea Dragon: 'You are braver than most who visit my lair.'",
                        "Sea Dragon: 'Return with knowledge, and you may earn my respect.'"
                    ];
                    text += dragonLore[(dragonDialogueCount % dragonLore.length)] + "\n";
                    dragonDialogueCount++;
                    // Designer (room 0)
                } else if (currentRoom === 0) {
                    const designerLore = [
                        "Designer: 'I create the finest garments in all the ocean realms.'",
                        "Designer: 'The king's wardrobe must be perfect. Perfection takes time.'",
                        "Designer: 'Dragon silk is the rarest material. So smooth, so strong.'",
                        "Designer: 'Fashion is an art form, not just clothing.'",
                        "Designer: 'I once dressed merfolk royalty. Those were glorious days.'",
                        "Designer: 'The sea dragon's mane produces the finest silk known.'",
                        "Designer: 'Every stitch must be perfect. The king accepts nothing less.'",
                        "Designer: 'I've been working on these royal clothes for months.'",
                        "Designer: 'The pirate ghost once asked me to repair his coat. I refused.'",
                        "Designer: 'The mermaid has exquisite taste in accessories.'",
                        "Designer: 'Thank you for your patience with my craft.'"
                    ];
                    text += designerLore[(designerDialogueCount % designerLore.length)] + "\n";
                    designerDialogueCount++;

                    // King (room 17)
                } else if (currentRoom === 17) {
                    const kingLore = [
                        "King: 'This throne has been in my family for generations.'",
                        "King: 'A king without proper attire is no king at all!'",
                        "King: 'The designer is taking FOREVER with my new clothes.'",
                        "King: 'Respect the throne. It is not for commoners.'",
                        "King: 'I rule these waters with wisdom and strength.'",
                        "King: 'The sea dragon and I have an understanding. Mutual respect.'",
                        "King: 'The mermaid is a dear friend of the royal court.'",
                        "King: 'Those sharks need to learn proper manners.'",
                        "King: 'The turtle elder is older than even my ancestors.'",
                        "King: 'The pirate ghost was once a problem. No longer.'",
                        "King: 'You have served me well, traveler.'"
                    ];
                    if (satOnThroneBeforeKingQuest && !kingQuestComplete) {
                        text += "King: 'I saw you sitting on MY throne! The audacity! Perhaps if you bring me my royal clothes, I'll forgive this transgression.'\n";
                    } else {
                        text += kingLore[(kingDialogueCount % kingLore.length)] + "\n";
                        kingDialogueCount++;
                    }

                    // Giant Squid (room 9)
                } else if (currentRoom === 9) {
                    if (!squidAsleep) {
                        const squidLore = [
                            "Giant Squid: 'RRRGH! No passage! The noise... the memories... too loud in this metal tomb!' *thrashes violently*",
                            "Giant Squid: 'The creaking... the echoes... they won't STOP!' *ink clouds swirl*",
                            "Giant Squid: 'My hatchlings... where are my hatchlings?!' *tentacles coil tighter*",
                            "Giant Squid: 'This ship... it haunts me... the sounds... the SOUNDS!' *writhes in distress*",
                            "Giant Squid: 'I cannot rest... cannot sleep... the memories are too loud!' *thrashes wildly*"
                        ];
                        text += squidLore[(squidDialogueCount % squidLore.length)] + "\n";
                        squidDialogueCount++;
                    } else {
                        text += "The Giant Squid sleeps peacefully, tentacles relaxed. Soft snoring sounds bubble through the water. It dreams of its hatchlings...\n";
                    }

                    // Seal (room 3 - Lobby)
                } else if (currentRoom === 3) {
                    const sealLore = [
                        "Seal: 'Oh dear, oh dear! The proposal is tonight and I still don't have a proper ring!'",
                        "Seal: *adjusts bowtie nervously* 'She's the most beautiful seal in all the ocean...'",
                        "Seal: 'I've been saving up courage for months! But without a ring, how can I propose?'",
                        "Seal: 'The ANCIENT_PEARL from the Turtle Elder would make the perfect ring, but I'm too nervous to ask him for it!'",
                        "Seal: 'What if she says no? What if my bowtie is crooked? What if‚Äî'",
                        "Seal: 'Love is terrifying... but worth it, right? RIGHT?!'",
                        "Seal: 'I practiced my proposal speech 847 times. Still doesn't sound right.'",
                        "Seal: 'The mermaid told me true love is about courage. I'm trying to be brave!'",
                        "Seal: 'My flippers won't stop shaking. Is that normal?'",
                        "Seal: 'She loves kelp gardens and stargazing through the surface...'",
                        "Seal: 'Thank you for believing in love, friend. You're the best!'"
                    ];
                    text += sealLore[(sealDialogueCount % sealLore.length)] + "\n";
                    sealDialogueCount++;

                    // Tiko (room 2 - Cave Entrance)
                } else if (currentRoom === 2) {
                    if (!tikoQuestComplete) {
                        const tikoLore = [
                            "Tiko: *sniffles* 'Grandpa said he'd be back before the current turned... that was three tides ago!'",
                            "Tiko: 'He went to the Turtle Palace but never came back for me...'",
                            "Tiko: *clutches seaweed map* 'I'm too little to swim that far alone...'",
                            "Tiko: 'What if something happened to Grandpa? What if he's hurt?'",
                            "Tiko: 'The Palace is so far... past the garden and the sharks...'",
                            "Tiko: 'Grandpa promised we'd explore together. He never breaks promises!'",
                            "Tiko: *wipes eyes* 'I'm trying to be brave like Grandpa taught me...'",
                            "Tiko: 'If you see an old turtle at the Palace, can you tell him I'm waiting?'",
                            "Tiko: 'I miss his stories... he knows so many...'",
                            "Tiko: 'Maybe he just forgot about me...' *looks down sadly*"
                        ];
                        text += tikoLore[(tikoDialogueCount % tikoLore.length)] + "\n";
                        tikoDialogueCount++;
                    } else {
                        text += "The cave entrance feels peaceful now. Tiko and his grandpa reunited thanks to you.\n";
                    }

                    // Gambler (room 1)
                } else if (currentRoom === 1) {
                    const gamblerLore = [
                        "Gambler: 'Just one more bet... I can win it all back...'",
                        "Gambler: 'I used to be rich, you know. Before... before the losses.'",
                        "Gambler: 'The treasure room... if only I could get there...'",
                        "Gambler: 'Lady Luck has abandoned me in these depths.'",
                        "Gambler: 'I lost everything to this cursed wheel.'",
                        "Gambler: 'One good bet could change everything!'",
                        "Gambler: 'The pirate ghost won't lend me treasure. Selfish spirit.'",
                        "Gambler: 'I dream of gold coins and winning streaks.'",
                        "Gambler: 'The sea dragon probably has treasures beyond imagination.'",
                        "Gambler: 'My hands shake when I think of one... more... spin...'",
                        "Gambler: 'You're a good person. Unlike this wheel.'"
                    ];
                    text += gamblerLore[(gamblerDialogueCount % gamblerLore.length)] + "\n";
                    gamblerDialogueCount++;

                    // Crew Member (room 12 - Deck)
                } else if (currentRoom === 12) {
                    const crewLore = [
                        "Crew Member: 'I miss the stars... the night sky above the waves.'",
                        "Crew Member: 'Been underwater so long, I've forgotten what the moon looks like.'",
                        "Crew Member: 'The captain kept the telescope in the crow's nest.'",
                        "Crew Member: 'We used to navigate by the stars. Now we're lost forever.'",
                        "Crew Member: 'The pirate life was grand until we sank.'",
                        "Crew Member: 'I wonder if the constellations have changed since we went down.'",
                        "Crew Member: 'The crow's nest still has our old telescope, I think.'",
                        "Crew Member: 'One last look at the night sky... that's all I want.'",
                        "Crew Member: 'The captain has his hat. I just want my stars back.'",
                        "Crew Member: 'The cook used to make us stew while we watched the stars.'",
                        "Crew Member: 'You've given me something precious. Thank you, friend.'"
                    ];
                    text += crewLore[(crewDialogueCount % crewLore.length)] + "\n";
                    crewDialogueCount++;
                    // Ship's Cook (room 4)
                } else if (currentRoom === 4) {
                    const cookLore = [
                        "Cook: 'A pinch of sea salt makes every dish better.'",
                        "Cook: 'I've cooked for pirates, kings, and merfolk alike.'",
                        "Cook: 'The best stew is made with fresh seaweed from the garden.'",
                        "Cook: 'Beware the sharks if you go foraging.'",
                        "Cook: 'The mermaid once gave me a recipe for happiness.'",
                        "Cook: 'The turtle elder prefers his soup slow-cooked.'",
                        "Cook: 'The sea dragon likes his meals spicy.'",
                        "Cook: 'The pirate ghost always wanted extra rum in his stew.'",
                        "Cook: 'The king's room once hosted grand feasts.'",
                        "Cook: 'You look hungry! Stay for a meal.'",
                        "Cook: 'Come back anytime, friend. There‚Äôs always a place at my table.'"
                    ];
                    text += cookLore[(cookDialogueCount % cookLore.length)] + "\n";
                    cookDialogueCount++;
                } else {
                    text += "There is nobody to talk with here.";
                }
                setText(text);
            }

            function takeQuest() {
                let text = "\n=== QUEST ===\n";
                // Mermaid quest (CRYSTAL)
                if (currentRoom === 7 && !mermaidQuestStarted) {
                    mermaidQuestStarted = true;
                    text += "The mermaid glides closer, her voice shimmering: 'Adventurer, would you bring me a rare CRYSTAL from the crystal room? Its light would brighten my collection and my heart.'";
                } else if (currentRoom === 7 && mermaidQuestStarted && !mermaidQuestComplete) {
                    text += "Mermaid: 'Have you found the CRYSTAL yet? Its glow is said to rival the stars above. Please, bring it to me from the crystal room.'";
                } else if (currentRoom === 7 && mermaidQuestComplete) {
                    text += "Mermaid: 'You have already brought me the CRYSTAL, dear friend. My gratitude is as deep as the sea.'";
                }

                else if (currentRoom === 18) {
                    // ‚úÖ CRITICAL FIX: Tiko check FIRST + setText BEFORE return
                    if (inventory.includes("TIKO") && !tikoQuestComplete) {
                        text += "Turtle Elder notices Tiko in your arms and his eyes widen with recognition.\n";
                        text += "Turtle Elder: 'That hatchling... could it be?'\n";
                        text += "Tiko: *gasps* 'GRANDPA!'\n";
                        text += "Turtle Elder: 'My child! You found him!'\n";
                        text += "\nüí° To reunite them, use the GIVE ITEM button while holding TIKO.";
                        setText(text);  // ‚ö†Ô∏è MUST set text BEFORE returning
                        return; // Exit early - don't process gem quest
                    }

                    // Gem quest logic (no completion here - only hints/initiation)
                    if (!turtleQuestStarted) {
                        turtleQuestStarted = true;
                        text += "The Turtle Elder speaks slowly: 'Young traveler, my precious GEM is lost in the gem room. Would you help an old turtle and return it to me?'\n";
                        text += "Quest started: Retrieve the GEM from the Gem Room";
                    }
                    else if (turtleQuestStarted && !turtleQuestComplete) {
                        if (inventory.includes("GEM")) {
                            text += "Turtle Elder: 'I see you carry my GEM! To return it properly, please use the GIVE ITEM button.'";
                        } else {
                            text += "Turtle Elder: 'Patience and persistence, young one. The GEM from the gem room awaits your steady hand.'\n";
                            text += "Hint: The Gem Room is east of the King's Room.";
                        }
                    }
                    else if (turtleQuestComplete) {
                        text += "Turtle Elder: 'You have already returned my GEM. May wisdom guide your path.'";
                    }
                    setText(text); // Set text for gem quest cases
                }
                // Shark quest (SHARKPLUSH)
                else if (currentRoom === 19 && !sharkQuestStarted) {
                    sharkQuestStarted = true;
                    text += "Doug swims forward, looking sad: 'Hey... we lost something really important to us.'\nSmug crosses his fins: 'Our SHARKPLUSH. It's in the storage room but... it's kinda creepy in there.'\nShrug: 'We're not scared or anything.'\nDoug: 'Will you get it for us? Please?'";
                } else if (currentRoom === 19 && sharkQuestStarted && !sharkQuestComplete) {
                    if (sharkPlushUsed) {
                        text += "Doug looks heartbroken: 'You... you USED our precious plush?! How could you...'\nSmug: 'That's seriously not cool, dude.'\nShrug: 'Yeah. Not cool.'";
                    } else {
                        text += "Doug: 'Our SHARKPLUSH is in the storage room. Please bring it back safely.'\nSmug: 'And don't mess it up!'\nShrug: 'Please.'";
                    }
                } else if (currentRoom === 19 && sharkQuestComplete) {
                    text += "Doug hugs the plush happily: 'Thank you so much for returning our treasure!'\nSmug: 'You're alright, for a land-dweller.'\nShrug: 'Thanks.'";
                }
                // Pirate quest (HAT)
                else if (currentRoom === 10 && !pirateQuestStarted) {
                    pirateQuestStarted = true;
                    if (pirateGhostMad) {
                        text += "The Pirate Ghost's eyes narrow: 'Ye dare wear me hat before returning it? That be a bold move, matey! Bring it here, and maybe I'll forgive yer insolence.'";
                    } else {
                        text += "The Pirate Ghost bellows: 'Arrr! Me hat be missin', lost in the sunken ship. Fetch it for me, and I'll owe ye a favor, matey!'";
                    }
                } else if (currentRoom === 10 && pirateQuestStarted && !pirateQuestComplete) {
                    if (pirateGhostMad) {
                        text += "Pirate Ghost: 'I see ye have me hat... but it belongs to me! Return it now, and perhaps I'll not haunt ye forever!'";
                    } else {
                        text += "Pirate Ghost: 'Still no sign of me hat? It's somewhere in the sunken ship. Don't keep a restless spirit waitin'!'";
                    }
                } else if (currentRoom === 10 && pirateQuestComplete) {
                    text += "Pirate Ghost: 'Ye already returned me hat, matey. I'll not forget yer kindness!'";
                }
                // Designer quest (SILK)
                else if (currentRoom === 0 && !designerQuestStarted) {
                    designerQuestStarted = true;
                    text += "The Designer sighs dramatically: 'I'm creating royal clothes for the king, but I need one crucial material‚ÄîSILK from the sea dragon's mane. It's impossibly rare. Would you brave the dragon's lair to get it for me?'";
                } else if (currentRoom === 0 && designerQuestStarted && !designerQuestComplete) {
                    text += "Designer: 'Have you obtained the dragon's SILK yet? The king is growing impatient, and so am I! The dragon's lair is to the south of the shark grove.'";
                } else if (currentRoom === 0 && designerQuestComplete) {
                    text += "Designer: 'The royal clothes are finished, thanks to you. A masterpiece!'";
                }

                // King quest (ROYAL_CLOTHES)
                else if (currentRoom === 17 && !kingQuestStarted) {
                    kingQuestStarted = true;
                    if (satOnThroneBeforeKingQuest) {
                        text += "The King glares at you: 'You DARED to sit upon my throne?! I should have you banished! However... if you bring me my ROYAL_CLOTHES from the designer, I may forgive your insolence.'";
                    } else {
                        text += "The King speaks regally: 'I have been waiting for my new ROYAL_CLOTHES from the designer. A king must look his finest. Fetch them for me, will you?'";
                    }
                } else if (currentRoom === 17 && kingQuestStarted && !kingQuestComplete) {
                    if (satOnThroneBeforeKingQuest) {
                        text += "King: 'I'm still furious about you sitting on my throne! Bring me those ROYAL_CLOTHES from the designer, and perhaps I'll forgive you.'";
                    } else {
                        text += "King: 'Where are my ROYAL_CLOTHES? The designer should have them ready by now!'";
                    }
                } else if (currentRoom === 17 && kingQuestComplete) {
                    text += "King: 'Ah, finally dressed properly! You have served your king well.'";
                }

                // Gambler quest (CHEST)
                else if (currentRoom === 1 && !gamblerQuestStarted) {
                    gamblerQuestStarted = true;
                    text += "The Gambler grabs your arm desperately: 'Please! I need one more chance! There's a treasure CHEST in the treasure room. If you bring it to me, I can bet it all... I can win everything back! Please, you have to help me!'";
                } else if (currentRoom === 1 && gamblerQuestStarted && !gamblerQuestComplete) {
                    text += "Gambler: 'The treasure CHEST! Did you find it? It's in the treasure room, south of the king's room! Please, I need it for one last bet!'";
                } else if (currentRoom === 1 && gamblerQuestComplete) {
                    text += "Gambler: 'I can't believe it... I WON! After all these years! You've given me a second chance at life!'";
                }

                // Crew Member quest (TELESCOPE)
                else if (currentRoom === 12 && !crewQuestStarted) {
                    crewQuestStarted = true;
                    text += "The Crew Member gazes upward wistfully: 'I haven't seen the stars in so long... The old TELESCOPE is up in the crow's nest. Could you bring it to me? I just want to see the night sky one last time...'";
                } else if (currentRoom === 12 && crewQuestStarted && !crewQuestComplete) {
                    text += "Crew Member: 'The TELESCOPE should still be in the crow's nest, directly above us. Please, I dream of the stars every night...'";
                } else if (currentRoom === 12 && crewQuestComplete) {
                    text += "Crew Member: 'The stars... they're as beautiful as I remember. Thank you, friend. Thank you.'";
                }

                // Dragon quest (DRAGONEGG)
                else if (currentRoom === 20 && !dragonQuestStarted) {
                    dragonQuestStarted = true;
                    text += "*voice rumbles with restrained anguish* 'My hatchling's egg... taken while I hunted. I have not slept since. The currents carry only silence where its heartbeat should be. Will you bring my child home?'";
                } else if (currentRoom === 20 && dragonQuestStarted && !dragonQuestComplete) {
                    text += "Sea Dragon: 'The DRAGONEGG is still missing. Seek it in the cellar and return it to its rightful place.'";
                } else if (currentRoom === 20 && dragonQuestComplete) {
                    text += "Sea Dragon: 'You have already returned the DRAGONEGG. My respect is yours.'";
                }
                // Squid quest (SINGING_SHELL) - Not a traditional quest, handled in USE
                else if (currentRoom === 9 && !squidAsleep) {
                    text += "The Giant Squid is too distressed to communicate properly. Perhaps something soothing could calm it? The Mermaid mentioned her shell contains a lullaby...";
                }

                // Seal quest (ANCIENT_PEARL)
                else if (currentRoom === 3 && !sealQuestStarted) {
                    sealQuestStarted = true;
                    text += "The Seal waddles over frantically: 'Oh, please help me! I'm proposing to my beloved tonight, but I need a proper ring! The ANCIENT_PEARL from the Turtle Elder would be PERFECT‚Äîit's been passed down through generations and glows with inner light! But I'm too nervous to ask him for it myself! The luster, the glow‚Äîit's exactly what she deserves! Would you get it for me? Please?!'";
                } else if (currentRoom === 3 && sealQuestStarted && !sealQuestComplete) {
                    text += "Seal: 'Did you get the ANCIENT_PEARL? The Turtle Elder has it at the Turtle Palace! I need it for the proposal ring! Tonight's the night!'";
                } else if (currentRoom === 3 && sealQuestComplete) {
                    text += "Seal: *blushes* 'She said YES! We're getting married! You made my dreams come true!'";

                    // Tiko quest (Bring him to Grandpa)
                } else if (currentRoom === 2 && !tikoQuestStarted) {
                    tikoQuestStarted = true;
                    text += "Tiko looks up at you with big, teary eyes: 'Please, can you help me? My Grandpa went to the Turtle Palace and never came back! He said he'd only be gone for one tide, but it's been THREE! I'm too small to swim there alone... Could you... could you take me there to find him? I promise I'll be good and hold on tight!'";
                } else if (currentRoom === 2 && tikoQuestStarted && !tikoQuestComplete) {
                    text += "Tiko: *sniffles* 'Will you take me to the Turtle Palace to find Grandpa? I'm ready whenever you are...'";
                } else if (currentRoom === 2 && tikoQuestComplete) {
                    text += "Tiko: 'Grandpa and I are together again! We're never going to be apart! Thank you, thank you, THANK YOU!'";
                }

                // Cook quest (SEAWEED)
                else if (currentRoom === 4 && !cookQuestStarted) {
                    cookQuestStarted = true;
                    text += "The Cook waves a ladle: 'Ahoy, friend! I need the freshest SEAWEED from the garden for my legendary stew. Can you fetch it for me?'";
                } else if (currentRoom === 4 && cookQuestStarted && !cookQuestComplete) {
                    text += "Cook: 'Still no SEAWEED? My stew won't be the same without it! Please, bring some from the garden.'";
                } else if (currentRoom === 4 && cookQuestComplete) {
                    text += "Cook: 'You've already brought me the SEAWEED! The stew is a masterpiece, thanks to you.'";
                } else {
                    text += "There is no quest available for you here.";
                }
                setText(text);
            }

            function handleCompanionChoice(companion) {
                companionChosen = companion;
                playEndingSequence(companion);
            }

            function playEndingSequence(companion) {
                let text = "\n" + "=".repeat(50) + "\n";

                // Journey dialogue based on companion
                if (companion === 'mermaid') {
                    text += "üßú‚Äç‚ôÄÔ∏è THE MERMAID'S FAREWELL üßú‚Äç‚ôÄÔ∏è\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The mermaid takes your hand, her eyes shimmering like pearls.\n\n";
                    text += "Mermaid: 'You brought me the CRYSTAL, but you gave me something more‚Äî\n";
                    text += "a reminder that kindness exists even in the deepest waters.\n";
                    text += "Come, I will sing you home.'\n\n";
                    text += "She begins to sing, and the water around you glows with ethereal light.\n";
                    text += "The current carries you upward, spiraling through columns of bubbles.\n";
                    text += "Her voice echoes: 'Remember the ocean, dear friend. We are forever connected.'\n\n";
                    text += "You break the surface...\n\n";

                } else if (companion === 'turtle') {
                    text += "üê¢ THE TURTLE ELDER'S FAREWELL üê¢\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The ancient turtle nods slowly, his eyes filled with timeless wisdom.\n\n";
                    text += "Turtle Elder: 'You returned my GEM, but more importantly,\n";
                    text += "you showed patience and respect. These are rare treasures.\n";
                    text += "I will guide you home, as the currents have guided me for centuries.'\n\n";
                    text += "He swims beside you with surprising grace, the ocean parting before him.\n";
                    text += "Turtle Elder: 'Life is a journey, young one. Take your time, but keep moving forward.'\n\n";
                    text += "You ascend slowly, peacefully, breaking through to the sunlight...\n\n";

                } else if (companion === 'pirate') {
                    // Check if player wore the hat
                    if (pirateGhostMad) {
                        // BAD ENDING - Betrayal
                        text += "‚ò†Ô∏è THE PIRATE'S BETRAYAL ‚ò†Ô∏è\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The Pirate Ghost grins wickedly as you approach.\n\n";
                        text += "Pirate Ghost: 'Ye returned me hat, aye, but ye WORE it first!\n";
                        text += "Ye disrespected the captain's honor, matey.\n";
                        text += "Now ye'll pay the price...'\n\n";
                        text += "His ghostly form swirls around you, and suddenly you feel cold‚Äîso cold.\n\n";
                        text += "Pirate Ghost: 'WELCOME TO ME CREW, FOREVER!'\n\n";
                        text += "Your body grows transparent. You try to swim up, but you're bound to the depths.\n";
                        text += "The ship's deck becomes your eternal prison.\n";
                        text += "You are now one of the undead crew, sailing the ghostly seas...\n\n";
                        text += "üíÄ You are trapped in the underwater realm forever. üíÄ\n\n";
                    } else {
                        // GOOD ENDING - Honorable
                        text += "‚öì THE PIRATE'S FAREWELL ‚öì\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The Pirate Ghost tips his hat to you with genuine respect.\n\n";
                        text += "Pirate Ghost: 'Ye returned me hat with honor, matey.\n";
                        text += "Ye've got the heart of a true sailor!\n";
                        text += "Come aboard‚Äîme ship sails one last time!'\n\n";
                        text += "The ghostly vessel rises from the depths, sails billowing with phantom wind.\n";
                        text += "You stand at the helm beside him as the ship surges upward through the water.\n\n";
                        text += "Pirate Ghost: 'The sea be freedom, friend. Never forget that!'\n\n";
                        text += "The ship breaks through the waves into glorious sunlight...\n\n";
                    }

                } else if (companion === 'dragon') {
                    text += "üêâ THE SEA DRAGON'S FAREWELL üêâ\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Sea Dragon lowers his massive head, his eyes glowing with ancient power.\n\n";
                    text += "Sea Dragon: 'You returned my DRAGONEGG when others would have kept it.\n";
                    text += "You have proven yourself brave and trustworthy.\n";
                    text += "Climb upon my back‚ÄîI will carry you home.'\n\n";
                    text += "You grasp his scales as he surges upward with incredible speed.\n";
                    text += "The water rushes past, and you feel the raw power of the ocean itself.\n\n";
                    text += "Sea Dragon: 'Remember this strength, human. You carry it within you now.'\n\n";
                    text += "You explode through the surface in a cascade of water...\n\n";

                } else if (companion === 'cook') {
                    // Check if player used the seaweed before giving it
                    if (cookGivenUsedSeaweed) {
                        // BAD ENDING - Eternal Apprentice
                        text += "üç≤ THE COOK'S REVENGE üç≤\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The Cook's warm smile suddenly turns cold.\n\n";
                        text += "Cook: 'Ye thought I wouldn't notice, did ye?\n";
                        text += "That SEAWEED ye brought me... it was USED! Tainted!\n";
                        text += "Ye ruined me legendary stew with yer carelessness!'\n\n";
                        text += "His ladle points at you accusingly.\n\n";
                        text += "Cook: 'I needed an apprentice anyway, and now I've got one‚ÄîFOREVER!\n";
                        text += "Ye'll learn proper cooking if it takes an eternity!'\n\n";
                        text += "Magical chains of kitchen utensils wrap around you.\n";
                        text += "You try to swim away, but you're bound to the galley...\n\n";
                        text += "Cook: 'No no NO! Ye're choppin' those kelp pieces all wrong!\n";
                        text += "Start over! And this time with RESPECT for the ingredients!'\n\n";
                        text += "Days turn to weeks, weeks to months, months to years...\n";
                        text += "You are forever his apprentice, never good enough,\n";
                        text += "always being scolded in the eternal kitchen.\n\n";
                        text += "üç≥ You are trapped as the Cook's apprentice forever. üç≥\n\n";
                    } else {
                        // GOOD ENDING
                        text += "üç≤ THE COOK'S FAREWELL üç≤\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The Cook wipes a tear from his eye and smiles warmly.\n\n";
                        text += "Cook: 'Ye brought me fresh SEAWEED for me stew, but ye gave me something better‚Äî\n";
                        text += "good company and a willing heart.\n";
                        text += "Come, let's share one last meal before ye go.'\n\n";
                        text += "You sit together, savoring a final bowl of the legendary stew.\n\n";
                        text += "Cook: 'Remember, friend‚Äîhome isn't just a place. It's where ye find warmth.\n";
                        text += "Now, let's get ye back to yours.'\n\n";
                        text += "He guides you up through a current that smells of spices and comfort...\n\n";
                    }

                } else if (companion === 'designer') {
                    text += "üëî THE DESIGNER'S FAREWELL üëî\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Designer adjusts their glasses and smiles warmly.\n\n";
                    text += "Designer: 'You brought me dragon silk when no one else would dare.\n";
                    text += "You have an eye for quality and courage in equal measure.\n";
                    text += "Let me craft you a safe passage home‚Äîwith style, of course.'\n\n";
                    text += "They weave currents of water around you like fabric,\n";
                    text += "creating a shimmering pathway that spirals upward.\n\n";
                    text += "Designer: 'Remember: true beauty comes from within, but a good outfit never hurts!'\n\n";
                    text += "You ascend through their aquatic couture, emerging at the surface in elegance...\n\n";

                } else if (companion === 'king') {
                    // Check if player sat on throne before completing quest
                    if (satOnThroneBeforeKingQuest) {
                        // BAD ENDING - Locked in cage
                        text += "üëë THE KING'S WRATH üëë\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The King's expression darkens as you approach.\n\n";
                        text += "King: 'You thought I would forget?\n";
                        text += "You SAT upon MY THRONE without permission!\n";
                        text += "You may have brought me my clothes, but that insult...\n";
                        text += "That insult can NEVER be forgiven!'\n\n";
                        text += "He raises his scepter, and golden chains materialize around you.\n\n";
                        text += "King: 'You wanted to sit on a throne? Now you'll sit FOREVER!\n";
                        text += "Guards! Take this pretender to the Royal Cage!'\n\n";
                        text += "You're dragged through the depths to a golden cage.\n";
                        text += "As you're thrown inside, you see three familiar faces...\n\n";
                        text += "Doug looks up sadly: 'Oh no... not you too. The King got you as well?'\n\n";
                        text += "Smug sighs: 'Let me guess‚Äîyou sat on his throne, didn't you?\n";
                        text += "Yeah, he REALLY doesn't like that. We may have... borrowed some royal jewelry once.\n";
                        text += "Been here ever since.'\n\n";
                        text += "Shrug shrugs: 'It's not so bad. You get used to it after the first century or so.'\n\n";
                        text += "Doug: 'At least we have company now. Got any stories to pass the time?'\n\n";
                        text += "Smug: 'We've got literally forever to hear them.'\n\n";
                        text += "Shrug: 'Forever is a long time.'\n\n";
                        text += "The cage door slams shut with a resounding clang.\n";
                        text += "You and the Shark Trio sit together in the golden cage,\n";
                        text += "prisoners of the crown for all eternity...\n\n";
                        text += "Doug tries to smile: 'Hey, at least we're not alone anymore.'\n\n";
                        text += "üëë YOU ARE IMPRISONED IN THE ROYAL CAGE FOREVER üëë\n\n";
                    } else {
                        // GOOD ENDING
                        text += "üëë THE KING'S FAREWELL üëë\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The King stands tall in his royal clothes, commanding and regal.\n\n";
                        text += "King: 'You have served your king faithfully and well.\n";
                        text += "You showed proper respect for the throne and the crown.\n";
                        text += "Now, I shall grant you royal escort back to your realm!'\n\n";
                        text += "He raises his scepter, and a golden chariot pulled by seahorses appears.\n";
                        text += "You ride in royal splendor as the ocean parts before you.\n\n";
                        text += "King: 'Go forth with the blessing of the crown. You are always welcome in my kingdom.'\n\n";
                        text += "The chariot breaks through the surface in a cascade of golden light...\n\n";
                    }

                } else if (companion === 'gambler') {
                    text += "üé∞ THE GAMBLER'S FAREWELL üé∞\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Gambler grins, his eyes bright with renewed hope.\n\n";
                    text += "Gambler: 'You gave me my life back! That last bet... I finally won!\n";
                    text += "All those years of loss, washed away in one perfect spin.\n";
                    text += "Let me bet on YOU one more time‚ÄîI'll get you home, I promise!'\n\n";
                    text += "He closes his eyes and whispers to Lady Luck.\n";
                    text += "The currents shift impossibly in your favor, carrying you upward.\n\n";
                    text += "Gambler: 'Sometimes the best bet is on a friend. May fortune smile on you always!'\n\n";
                    text += "You rise through the water on a streak of pure luck...\n\n";

                } else if (companion === 'crew') {
                    text += "‚≠ê THE CREW MEMBER'S FAREWELL ‚≠ê\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Crew Member clutches the telescope, smiling peacefully.\n\n";
                    text += "Crew Member: 'You brought me the stars... now let me guide you by them.\n";
                    text += "I remember every constellation, every navigation route.\n";
                    text += "I'll sail you home the way we used to‚Äîby starlight.'\n\n";
                    text += "They look through the telescope and plot a course.\n";
                    text += "You swim together, following the stellar path they chart above.\n\n";
                    text += "Crew Member: 'The stars never abandon us. They're always there, waiting to guide us home.'\n\n";
                    text += "You break through the surface under a canopy of stars...\n\n";

                } else if (companion === 'squid') {
                    text += "ü¶ë THE GIANT SQUID'S FAREWELL ü¶ë\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Giant Squid stirs from its peaceful slumber, its intelligent eyes focusing on you.\n\n";
                    text += "Giant Squid: 'You... you gave me peace. The lullaby... it silenced the screaming memories.\n";
                    text += "For the first time in decades, I dreamed of my hatchlings without pain.\n";
                    text += "Let me repay this kindness‚ÄîI will carry you home.'\n\n";
                    text += "The massive squid gently wraps a tentacle around you, cradling you safely.\n";
                    text += "With powerful propulsion, it rockets through the water at incredible speed.\n\n";
                    text += "Giant Squid: 'The surface world awaits. May you find the same peace you gave me.'\n\n";
                    text += "You burst through the waves in a spray of ink and gratitude...\n\n";

                } else if (companion === 'seal') {
                    text += "ü¶≠ THE SEAL'S FAREWELL ü¶≠\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "The Seal waddles over excitedly, now wearing a matching ring with his beloved.\n\n";
                    text += "Seal: 'She said YES! We're getting married, and it's all because of you!\n";
                    text += "You helped me find the courage to propose. You gave me my happily ever after.\n";
                    text += "Now let me help you find yours‚Äîlet's get you home!'\n\n";
                    text += "The Seal and his fianc√©e swim alongside you, guiding you with joyful barks.\n";
                    text += "Their love radiates through the water, creating a warm current that carries you upward.\n\n";
                    text += "Seal: 'Thank you for believing in love! Visit us for the wedding!'\n\n";
                    text += "You surface surrounded by the happy couple's cheerful splashing...\n\n";

                } else if (companion === 'tiko') {
                    text += "üê¢ TIKO & THE TURTLE ELDER'S FAREWELL üê¢\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "Tiko and the Turtle Elder swim up to you together, flippers entwined.\n\n";
                    text += "Tiko: 'You brought me and Grandpa back together! You're my hero!'\n\n";
                    text += "Turtle Elder: 'You reunited our family. This debt can never be fully repaid,\n";
                    text += "but we can guide you home with the wisdom of generations.\n";
                    text += "Come, young one. Tiko and I will show you the ancient turtle paths.'\n\n";
                    text += "The two turtles swim on either side of you, following currents only they know.\n";
                    text += "Tiko chatters excitedly while the Elder hums an ancient sea song.\n\n";
                    text += "Turtle Elder: 'Family is the greatest treasure. Remember this always.'\n";
                    text += "Tiko: 'Come visit us again! Grandpa tells the BEST stories!'\n\n";
                    text += "You rise gently through the water, guided by love and wisdom...\n\n";

                } else if (companion === 'sharks') {
                    // Check if player used the plush
                    if (sharkPlushUsed) {
                        // BAD ENDING - Sharks attack, possible rescue
                        text += "ü¶à THE SHARKS' REVENGE ü¶à\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The three sharks circle around you menacingly.\n\n";
                        text += "Doug's eyes are filled with tears and anger:\n";
                        text += "'You said you'd take us home... but you DAMAGED our precious plush!\n";
                        text += "You USED it! You TORE it! How could you?!'\n\n";
                        text += "Smug bares his teeth: 'We trusted you, and you betrayed that trust.'\n\n";
                        text += "Shrug, for once showing emotion: 'Not cool. Not cool at all.'\n\n";
                        text += "The sharks move closer, their jaws opening wide...\n\n";

                        // Check who can save you
                        const pirateCanSave = !pirateGhostMad;
                        const cookCanSave = !cookGivenUsedSeaweed;
                        const kingCanSave = !satOnThroneBeforeKingQuest; // King only saves if quest is complete

                        if (pirateCanSave && cookCanSave && kingCanSave) {
                            // ALL THREE SAVE YOU
                            text += "Suddenly, the water explodes with activity!\n\n";
                            text += "A ghostly ship bursts through from above!\n";
                            text += "Pirate Ghost: 'AVAST! Nobody touches me honorable friend!'\n\n";
                            text += "The Cook charges in wielding his massive ladle!\n";
                            text += "Cook: 'Back off! This one brought me the finest seaweed!'\n\n";
                            text += "And then, a golden chariot pulled by seahorses appears!\n";
                            text += "King: 'BY ROYAL DECREE, this citizen is under the crown's protection!'\n\n";
                            text += "The sharks retreat, completely overwhelmed by the combined force.\n\n";
                            text += "Doug (swimming away fast): 'Okay, okay! We're leaving!'\n";
                            text += "Smug: 'The KING is here?! We're out!'\n";
                            text += "Shrug: 'Yeah, we're definitely out.'\n\n";
                            text += "Your three saviors surround you protectively.\n\n";
                            text += "Pirate Ghost: 'Ye treated me with honor!'\n";
                            text += "Cook: 'Ye brought me fresh ingredients!'\n";
                            text += "King: 'You served your kingdom well!'\n\n";
                            text += "Together, they escort you to the surface in a magnificent procession...\n\n";

                        } else if (pirateCanSave && cookCanSave) {
                            // PIRATE AND COOK SAVE YOU
                            text += "Suddenly, a ghostly ship bursts through the water!\n\n";
                            text += "Pirate Ghost: 'AVAST! Nobody eats me honorable friend!'\n\n";
                            text += "The Cook swims in wielding a giant ladle:\n";
                            text += "Cook: 'Back off, ye overgrown guppies! This one's under MY protection!'\n\n";
                            text += "The sharks retreat, startled by the combined force.\n\n";
                            text += "Doug (swimming away): 'Fine! But we won't forget this!'\n";
                            text += "Smug: 'You got lucky this time!'\n";
                            text += "Shrug: 'Whatever.'\n\n";
                            text += "The Pirate and Cook escort you to the surface together.\n\n";
                            text += "Pirate Ghost: 'Ye treated me with honor, so I return the favor.'\n";
                            text += "Cook: 'And ye brought me fresh seaweed. That's worth saving a life for!'\n\n";
                            text += "You break through to the surface, saved by your good deeds...\n\n";

                        } else if (pirateCanSave && kingCanSave) {
                            // PIRATE AND KING SAVE YOU
                            text += "Suddenly, a ghostly ship erupts from the depths!\n\n";
                            text += "Pirate Ghost: 'AVAST, YE SCURVY SHARKS!'\n\n";
                            text += "At the same time, a golden chariot appears!\n";
                            text += "King: 'BY ROYAL DECREE, this one is under crown protection!'\n\n";
                            text += "The sharks back away, intimidated by pirate and royalty combined.\n\n";
                            text += "Doug (retreating): 'The KING and a pirate ghost?! We're out!'\n";
                            text += "Smug: 'Way out of our league!'\n";
                            text += "Shrug: 'Yep, leaving.'\n\n";
                            text += "The Pirate and King nod to each other with respect.\n\n";
                            text += "Pirate Ghost: 'Ye showed honor, matey.'\n";
                            text += "King: 'You served your king well.'\n\n";
                            text += "They escort you to the surface in an unlikely alliance...\n\n";

                        } else if (cookCanSave && kingCanSave) {
                            // COOK AND KING SAVE YOU
                            text += "Suddenly, the Cook charges in wielding a massive ladle!\n\n";
                            text += "Cook: 'NOT IN MY OCEAN, YE DON'T!'\n\n";
                            text += "A golden chariot appears beside him!\n";
                            text += "King: 'This citizen is under royal protection!'\n\n";
                            text += "The sharks retreat before cook and crown.\n\n";
                            text += "Doug (swimming away): 'Royalty AND the cook?! Let's go!'\n";
                            text += "Smug: 'Way too much heat!'\n";
                            text += "Shrug: 'I'm out.'\n\n";
                            text += "The Cook and King share a respectful nod.\n\n";
                            text += "Cook: 'Ye brought me the finest seaweed!'\n";
                            text += "King: 'And served the kingdom faithfully.'\n\n";
                            text += "They guide you upward together in royal and culinary harmony...\n\n";

                        } else if (pirateCanSave) {
                            // ONLY PIRATE SAVES YOU
                            text += "Suddenly, a ghostly ship erupts from the depths!\n\n";
                            text += "Pirate Ghost: 'AVAST, YE SCURVY SHARKS! This one returned me hat with HONOR!\n";
                            text += "Nobody touches someone under the protection of Captain's honor!'\n\n";
                            text += "His spectral presence is so commanding that the sharks back away.\n\n";
                            text += "Doug (retreating): 'F-fine! We'll let it go this time...'\n";
                            text += "Smug: 'Only because the ghost is here!'\n";
                            text += "Shrug: 'Yeah, that.'\n\n";
                            text += "The Pirate Ghost's ship carries you to the surface.\n\n";
                            text += "Pirate Ghost: 'Ye made a mistake with the sharks, but ye treated ME right.\n";
                            text += "Honor demands I save ye. Don't waste this second chance!'\n\n";
                            text += "You break through to the sunlight, grateful for your earlier integrity...\n\n";

                        } else if (cookCanSave) {
                            // ONLY COOK SAVES YOU
                            text += "Suddenly, the Cook charges in wielding a massive ladle!\n\n";
                            text += "Cook: 'NOT IN MY OCEAN, YE DON'T! This one brought me the FINEST seaweed!\n";
                            text += "Anyone who respects ingredients respects LIFE!'\n\n";
                            text += "He swings his ladle with surprising ferocity, driving the sharks back.\n\n";
                            text += "Doug (swimming away): 'Ow! Okay, okay! We're leaving!'\n";
                            text += "Smug: 'That ladle hurts!'\n";
                            text += "Shrug: 'I'm out.'\n\n";
                            text += "The Cook guides you upward through the currents.\n\n";
                            text += "Cook: 'Ye made a mistake with those sharks, but ye showed me respect.\n";
                            text += "That kindness saved yer life today. Remember that!'\n\n";
                            text += "You break through to the surface, saved by a simple act of care...\n\n";

                        } else if (kingCanSave) {
                            // ONLY KING SAVES YOU
                            text += "Suddenly, a golden chariot pulled by seahorses appears!\n\n";
                            text += "King: 'HALT! BY ROYAL DECREE, this citizen is under the protection of the crown!'\n\n";
                            text += "The King's commanding presence radiates authority.\n";
                            text += "Even the sharks cannot defy a direct royal command.\n\n";
                            text += "Doug (bowing slightly): 'Y-your Majesty... we didn't know...'\n";
                            text += "Smug: 'We'll let it go this time, out of respect.'\n";
                            text += "Shrug: 'Yeah, respect.'\n\n";
                            text += "The sharks swim away, and the King's chariot surrounds you.\n\n";
                            text += "King: 'You served me faithfully. A king protects those who serve the crown.\n";
                            text += "Though you erred with the sharks, your service to me has earned my protection.'\n\n";
                            text += "You ascend in royal splendor, saved by the crown...\n\n";

                        } else {
                            // NO ONE SAVES YOU - YOU GET EATEN
                            text += "You look around desperately for help, but none comes.\n\n";
                            text += "The Pirate Ghost remembers you wearing his sacred hat...\n";
                            text += "The Cook remembers you trying to give him used seaweed...\n";
                            text += "The King... you never completed his quest.\n\n";
                            text += "No one is coming to save you.\n\n";
                            text += "Doug lunges forward: 'You hurt what we loved most!'\n";
                            text += "Smug: 'This is what you deserve!'\n";
                            text += "Shrug: 'Should've been nicer.'\n\n";
                            text += "The water turns dark as the sharks close in...\n\n";
                            text += "Your journey ends here, in the depths,\n";
                            text += "a reminder that every action has consequences.\n\n";
                            text += "ü¶à YOU HAVE BEEN EATEN BY THE SHARK TRIO ü¶à\n\n";
                            text += "Perhaps in another timeline, you would have made better choices...\n\n";
                        }

                    } else {
                        // GOOD ENDING
                        text += "ü¶à THE SHARKS' FAREWELL ü¶à\n";
                        text += "=".repeat(50) + "\n\n";
                        text += "The three sharks swim excitedly around you.\n\n";
                        text += "Doug clutches the SHARKPLUSH close: 'You brought back our treasure safely!\n";
                        text += "You're the best friend we've ever had!'\n\n";
                        text += "Smug grins: 'Yeah, you're pretty cool. For a land-dweller.\n";
                        text += "We'll get you home safe‚Äîthat's a promise from the toughest gang in the ocean!'\n\n";
                        text += "Shrug nods: 'We got you.'\n\n";
                        text += "The three sharks form a protective circle around you,\n";
                        text += "swimming in perfect synchronization toward the surface.\n";
                        text += "Other creatures part ways, respecting the Shark Trio's passage.\n\n";
                        text += "Doug: 'Thanks for seeing past our tough exterior...'\n";
                        text += "Smug: 'And for not judging us for caring about a plushie!'\n";
                        text += "Shrug: 'You're alright.'\n\n";
                        text += "You burst through the surface together, your new friends by your side...\n\n";
                    }
                }

                // Professor ending (only for good endings or rescued endings)
                const sharkGoodEnding = (companion === 'sharks' && !sharkPlushUsed);
                const sharkRescued = (companion === 'sharks' && sharkPlushUsed && (!pirateGhostMad || !cookGivenUsedSeaweed || !satOnThroneBeforeKingQuest));
                const sharkEaten = (companion === 'sharks' && sharkPlushUsed && pirateGhostMad && cookGivenUsedSeaweed && satOnThroneBeforeKingQuest);
                const kingBadEnding = (companion === 'king' && satOnThroneBeforeKingQuest);

                if (((companion !== 'pirate' || !pirateGhostMad) &&
                    (companion !== 'cook' || !cookGivenUsedSeaweed) &&
                    (companion !== 'sharks' || sharkGoodEnding || sharkRescued) &&
                    (companion !== 'king' || !kingBadEnding)) && !sharkEaten) {

                    text += "=".repeat(50) + "\n";
                    text += "üèñÔ∏è THE MAINLAND üèñÔ∏è\n";
                    text += "=".repeat(50) + "\n\n";
                    text += "You collapse on the sandy beach, gasping for air.\n";
                    text += "The sun is warm on your face. You're back.\n\n";
                    text += "A familiar voice shouts from nearby:\n\n";
                    text += "Professor: 'THERE YOU ARE! Do you have ANY idea how worried I've been?!\n";
                    text += "You disappeared for HOURS! I thought you'd drowned!\n";
                    text += "What on EARTH were you thinking?!'\n\n";
                    text += "You catch your breath and begin to tell your story...\n\n";

                    // Custom professor response based on companion
                    if (companion === 'mermaid') {
                        text += "You: 'Professor... I met a mermaid. She sang the most beautiful songs...\n";
                        text += "and I helped her find a crystal. She brought me home.'\n\n";
                        text += "Professor: '...A mermaid? You... you really went down there, didn't you?\n";
                        text += "Your eyes... they're different. Like you've seen wonders I can only dream of.'\n\n";
                    } else if (companion === 'turtle') {
                        text += "You: 'Professor... I met an ancient turtle elder. He taught me about patience,\n";
                        text += "about wisdom. I returned his precious gem to him.'\n\n";
                        text += "Professor: '...A turtle elder? You speak with such... maturity now.\n";
                        text += "Perhaps this journey taught you more than any classroom could.'\n\n";
                    } else if (companion === 'pirate') {
                        text += "You: 'Professor... I sailed with a pirate ghost! His ship rose from the depths!\n";
                        text += "I returned his captain's hat with honor.'\n\n";
                        text += "Professor: '...A pirate ghost?! Good heavens! But you... you returned with honor?\n";
                        text += "I see courage in you now that wasn't there before.'\n\n";
                    } else if (companion === 'dragon') {
                        text += "You: 'Professor... I rode a sea dragon! He trusted me with his dragon egg.\n";
                        text += "I've never felt such power!'\n\n";
                        text += "Professor: '...A sea dragon?! By all the legends... You've touched something\n";
                        text += "ancient and powerful. I can see it in your bearing.'\n\n";
                    } else if (companion === 'cook') {
                        text += "You: 'Professor... I met the kindest cook who taught me that home\n";
                        text += "is wherever you find warmth. I helped him make his legendary stew.'\n\n";
                        text += "Professor: '...A cook? You know, sometimes the simplest lessons are the deepest.\n";
                        text += "You seem... at peace. That's worth more than any treasure.'\n\n";

                    } else if (companion === 'squid') {
                        text += "You: 'Professor... I calmed a giant squid that was suffering from trauma.\n";
                        text += "A simple lullaby gave it the peace it desperately needed.'\n\n";
                        text += "Professor: '...A giant squid?! Those creatures are incredibly intelligent and emotional!\n";
                        text += "You showed compassion to something most would fear. Remarkable!'\n\n";
                    } else if (companion === 'seal') {
                        text += "You: 'Professor... I helped a nervous seal propose to his beloved.\n";
                        text += "Sometimes all someone needs is a little help to be brave.'\n\n";
                        text += "Professor: '...You played matchmaker underwater?! And they're getting married?!\n";
                        text += "You've learned that even the smallest acts of kindness can change lives!'\n\n";
                    } else if (companion === 'tiko') {
                        text += "You: 'Professor... I reunited a lost hatchling with his grandfather.\n";
                        text += "Their family was broken, and I helped make it whole again.'\n\n";
                        text += "Professor: '...You carried a young turtle all that way just to reunite them?!\n";
                        text += "That's true heroism‚Äîprotecting the innocent and preserving family bonds!'\n\n";

                    } else if (companion === 'designer') {
                        text += "You: 'Professor... I met a clothing designer who creates art from dragon silk.\n";
                        text += "They taught me that beauty and courage go hand in hand.'\n\n";
                        text += "Professor: '...Dragon silk?! You brought dragon materials to a designer?!\n";
                        text += "You've witnessed craftsmanship at its finest!'\n\n";
                    } else if (companion === 'king') {
                        if (!satOnThroneBeforeKingQuest) {
                            // Good ending
                            text += "You: 'Professor... I served an underwater king. He granted me royal escort home.'\n\n";
                            text += "Professor: '...A king?! You served royalty beneath the waves?!\n";
                            text += "You carry yourself with more dignity now.'\n\n";
                        }
                    } else if (companion === 'gambler') {
                        text += "You: 'Professor... I helped a gambler win back everything he lost.\n";
                        text += "Sometimes people just need one more chance.'\n\n";
                        text += "Professor: '...A gambler? You showed compassion to someone in despair?\n";
                        text += "That's a lesson more valuable than any treasure.'\n\n";
                    } else if (companion === 'crew') {
                        text += "You: 'Professor... I gave a lost crew member one last look at the stars.\n";
                        text += "Sometimes the smallest gift means everything.'\n\n";
                        text += "Professor: '...You brought peace to a lost soul?\n";
                        text += "You've learned what it means to truly help someone.'\n\n";
                    } else if (companion === 'sharks') {
                        if (sharkPlushUsed) {
                            // Rescued ending - only show if actually rescued
                            text += "You: 'Professor... I made mistakes, but I was saved by those I treated with kindness.'\n\n";
                            text += "Professor: 'Saved? From what?! What happened down there?!\n";
                            text += "You look shaken... but also wiser. Sometimes we learn the most from our errors.'\n\n";
                        } else {
                            // Good ending
                            text += "You: 'Professor... I befriended a trio of sharks! They were tough but so kind.\n";
                            text += "I helped them find their precious treasure.'\n\n";
                            text += "Professor: 'Sharks?! You... you made friends with SHARKS?!\n";
                            text += "My word! You have a gift for seeing the good in everyone.'\n\n";
                        }
                    }

                    text += "The Professor's stern expression softens.\n\n";
                    text += "Professor: 'I suppose... I suppose you've grown today.\n";
                    text += "The ocean has mysteries I'll never understand.\n";
                    text += "Come on‚Äîlet's get you home. But you're telling me EVERYTHING\n";
                    text += "over a hot meal!'\n\n";
                }

                text += "=".repeat(50) + "\n";
                text += "‚ú® THANKS FOR PLAYING! ‚ú®\n";
                text += "=".repeat(50) + "\n\n";

                if ((companion === 'pirate' && pirateGhostMad) ||
                    (companion === 'cook' && cookGivenUsedSeaweed) ||
                    (companion === 'king' && satOnThroneBeforeKingQuest) ||
                    (companion === 'sharks' && sharkPlushUsed && pirateGhostMad && cookGivenUsedSeaweed && !kingQuestComplete)) {
                    text += "You discovered a secret ending!\n";
                    if (companion === 'sharks' && sharkPlushUsed && pirateGhostMad && cookGivenUsedSeaweed && !kingQuestComplete) {
                        text += "The darkest ending of all... eaten by those you wronged.\n";
                        text += "Treating others with respect might have changed your fate...\n\n";
                    } else if (companion === 'king' && satOnThroneBeforeKingQuest) {
                        text += "You disrespected the crown and paid the ultimate price.\n";
                        text += "Some thrones are not meant to be sat upon...\n\n";
                    } else if (companion === 'pirate' && pirateGhostMad) {
                        text += "You betrayed the Pirate Ghost's trust and are doomed to sail with him forever.\n";
                        text += "Perhaps honoring your promises would lead to freedom...\n\n";
                    } else if (companion === 'cook' && cookGivenUsedSeaweed) {
                        text += "You angered those who trusted you and are bound to work for them forever.\n";
                        text += "Perhaps acting with more care for ingredients would lead to freedom...\n\n";
                    } else {
                        text += "Perhaps choosing differently or acting with more care would lead to freedom...\n\n";
                    }
                }

                text += "Your journey through the underwater realm has come to an end.\n";
                text += "The friends you made will remember you always.\n\n";
                text += "~ Underwater Adventure Game ~\n";

                setText(text);

                // Hide all action buttons after ending
                document.querySelectorAll('.action-panel button, .movement-panel button').forEach(btn => {
                    btn.style.display = 'none';
                });
            }

            function move(direction) {
                // Improved: auto-look after move, accessibility
                if (!gameStarted) {
                    setText("\nPlease click LOOK to begin your adventure first!");
                    return;
                }
                if (isSitting) {
                    setText("\nYou can't move while sitting! Press SIT/STAND to get up first.");
                    return;
                }
                const nextRoom = roomConnections[currentRoom][direction];
                if (nextRoom !== -1) {
                    // Storage room door logic
                    if ((currentRoom === 5 && nextRoom === 6 && !doorOpen) ||
                        (currentRoom === 6 && nextRoom === 5 && !doorOpen)) {
                        setText("\nThe door is locked. You need to find a way to open it.");
                        return;
                    }
                    // Cellar door logic
                    if ((currentRoom === 12 && nextRoom === 13 && !cellarOpen) ||
                        (currentRoom === 13 && nextRoom === 12 && !cellarOpen)) {
                        setText("\nThe cellar door is locked. You need a ghostly key to open it.");
                        return;
                    }
                    // Squid blocking logic
                    if ((currentRoom === 9 && nextRoom === 12 && !squidAsleep) ||
                        (currentRoom === 12 && nextRoom === 9 && !squidAsleep)) {
                        setText("\nThe Giant Squid's massive tentacles block your path, thrashing violently! You need to calm it somehow before you can pass.");
                        return;
                    }

                    currentRoom = nextRoom;
                    lookAround(); // Show new room info automatically
                } else {
                    const dirNames = ["NORTH", "SOUTH", "EAST", "WEST"];
                    setText(`\nYou can't go ${dirNames[direction]} from ${rooms[currentRoom]}.`);
                }
            }

            // === INITIALIZE GAME ===
            showIntroduction();
            // End of improvements and comments are in code above
        </script>
</body>

</html>